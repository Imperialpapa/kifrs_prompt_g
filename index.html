<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-IFRS 1019 DBO Validator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        [x-cloak] { display: none !important; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        },
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 antialiased" x-data="app()">

    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 w-64 bg-white border-r border-slate-200 z-30 transition-transform duration-300"
         :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'">
        
        <div class="h-16 flex items-center px-6 border-b border-slate-100">
            <div class="flex items-center gap-2 text-primary-600 font-bold text-xl">
                <i class="ph-fill ph-shield-check text-2xl"></i>
                <span>DBO Validator</span>
            </div>
        </div>

        <nav class="p-4 space-y-6">
            <template x-for="group in navGroups" :key="group.title">
                <div>
                    <div class="px-4 mb-2 text-xs font-bold text-slate-400 uppercase tracking-wider" x-text="group.title"></div>
                    <div class="space-y-1">
                        <template x-for="item in group.items" :key="item.id">
                            <button @click="if(item.id === 'settings') { settingsModalOpen = true } else { currentTab = item.id }; if(window.innerWidth < 1024) sidebarOpen = false"
                                    class="w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium transition-colors"
                                    :class="(item.id !== 'settings' && currentTab === item.id) ? 'bg-primary-50 text-primary-700' : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900'">
                                <i :class="item.icon" class="text-lg"></i>
                                <span x-text="item.label"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </template>
        </nav>

        <!-- Rule Selection Widget (Sidebar) -->
        <div class="px-4 mt-6">
            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">적용할 규칙</span>
                    <button @click="currentTab = 'rules'" class="text-xs text-primary-600 hover:underline">관리</button>
                </div>
                
                <div class="relative" x-init="loadRuleFiles()">
                    <select x-model="selectedSavedRuleId" 
                            class="w-full appearance-none bg-white border border-slate-300 text-slate-700 py-2 pl-3 pr-8 rounded-lg text-xs font-medium focus:outline-none focus:ring-2 focus:ring-primary-500 cursor-pointer shadow-sm">
                        <option value="" disabled>규칙 선택...</option>
                        <template x-for="rule in ruleFiles" :key="rule.id">
                            <option :value="rule.id" x-text="rule.file_name + ' (v' + rule.file_version + ')'"></option>
                        </template>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-slate-500">
                        <i class="ph ph-caret-down"></i>
                    </div>
                </div>
                
                <!-- Rule Info -->
                <div class="mt-2 flex items-center gap-2 text-[10px] text-slate-500" x-show="selectedSavedRuleId">
                    <i class="ph-fill ph-info text-primary-500"></i>
                    <span x-text="getRuleInfo(selectedSavedRuleId)"></span>
                </div>
            </div>
        </div>

        <div class="absolute bottom-0 w-full p-4 border-t border-slate-100 bg-white">
            <div class="space-y-3">
                <div class="flex items-center gap-2 px-4">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-xs font-semibold text-slate-600">System Online</span>
                </div>
                <div class="text-[10px] text-slate-400 font-mono leading-tight px-4">
                    <div x-text="frontendVersion"></div>
                    <div x-text="backendVersion"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div x-show="settingsModalOpen" x-cloak class="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6" @click.stop>
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                    <i class="ph-fill ph-gear text-slate-500"></i>
                    환경 설정
                </h3>
                <button @click="settingsModalOpen = false" class="text-slate-400 hover:text-slate-600">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>

            <div class="space-y-6">
                <!-- AI Provider Selection -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-3">AI 엔진 선택</label>
                    <div class="grid grid-cols-1 gap-3">
                        <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer transition-all hover:border-indigo-300"
                               :class="aiProvider === 'openai' ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-500' : 'border-slate-200'">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                                    <i class="ph-fill ph-openai-logo"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-slate-900 text-sm">OpenAI (GPT-4o)</div>
                                    <div class="text-xs text-slate-500">기본값. 균형 잡힌 성능.</div>
                                </div>
                            </div>
                            <input type="radio" name="ai_provider" value="openai" x-model="aiProvider" class="text-indigo-600 focus:ring-indigo-500">
                        </label>

                        <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer transition-all hover:border-blue-300"
                               :class="aiProvider === 'gemini' ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-slate-200'">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                                    <i class="ph-fill ph-google-logo"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-slate-900 text-sm">Google (Gemini 1.5)</div>
                                    <div class="text-xs text-slate-500">빠른 속도와 긴 컨텍스트 처리.</div>
                                </div>
                            </div>
                            <input type="radio" name="ai_provider" value="gemini" x-model="aiProvider" class="text-blue-600 focus:ring-blue-500">
                        </label>

                        <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer transition-all hover:border-orange-300"
                               :class="aiProvider === 'anthropic' ? 'border-orange-500 bg-orange-50 ring-1 ring-orange-500' : 'border-slate-200'">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600">
                                    <i class="ph-fill ph-brain"></i>
                                </div>
                                <div>
                                    <div class="font-semibold text-slate-900 text-sm">Anthropic (Claude 3)</div>
                                    <div class="text-xs text-slate-500">가장 뛰어난 한국어 이해 능력.</div>
                                </div>
                            </div>
                            <input type="radio" name="ai_provider" value="anthropic" x-model="aiProvider" class="text-orange-600 focus:ring-orange-500">
                        </label>
                    </div>
                    <p class="mt-2 text-xs text-slate-400">
                        * 선택한 AI의 API Key가 .env 파일에 설정되어 있어야 합니다.
                    </p>
                </div>
            </div>

            <div class="mt-8 flex justify-end">
                <button @click="settingsModalOpen = false" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-colors text-sm font-medium">
                    닫기
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="lg:ml-64 min-h-screen flex flex-col transition-all duration-300">
        
        <!-- Top Header -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 lg:px-8 sticky top-0 z-20">
            <button @click="sidebarOpen = !sidebarOpen" class="lg:hidden p-2 text-slate-500 hover:text-slate-700">
                <i class="ph ph-list text-2xl"></i>
            </button>
            
            <h1 class="text-lg font-semibold text-slate-800" x-text="navItems.find(i => i.id === currentTab)?.label || '상세 정보'"></h1>

            <div class="flex items-center gap-4">
                <button class="p-2 text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="ph ph-bell text-xl"></i>
                </button>
                <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center text-primary-700 font-bold text-sm">
                    K
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 p-4 lg:p-8 overflow-y-auto">
            
            <!-- VIEW: UPLOAD -->
            <div x-show="currentTab === 'upload'" x-transition.opacity>
                <div class="max-w-2xl mx-auto space-y-8 py-10">
                    
                    <div class="text-center space-y-3">
                        <h2 class="text-3xl font-bold text-slate-900">데이터 검증</h2>
                        <p class="text-slate-500">
                            좌측 메뉴에서 
                            <span class="font-semibold text-primary-600 bg-primary-50 px-2 py-0.5 rounded">적용할 규칙</span>을 확인 후, 
                            <br>직원 데이터 파일을 업로드하세요.
                        </p>
                    </div>

                    <!-- File A: Employee Data Only -->
                    <div class="bg-white rounded-2xl border-2 border-dashed border-slate-300 p-10 text-center transition-all hover:border-primary-400 hover:shadow-lg group relative cursor-pointer"
                         @dragover.prevent="dragOverA = true"
                         @dragleave.prevent="dragOverA = false"
                         @drop.prevent="handleDrop($event, 'A')"
                         @click="document.getElementById('fileA').click()"
                         :class="{'border-primary-500 bg-primary-50': dragOverA, 'border-green-400 bg-green-50': fileA}">
                        
                        <input type="file" id="fileA" accept=".xlsx,.xls" class="hidden" @change="handleFileSelect($event, 'A')">
                        
                        <div class="pointer-events-none space-y-4">
                            <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto transition-transform group-hover:scale-110 shadow-sm"
                                 :class="{'bg-green-100 text-green-600': fileA, 'bg-primary-100 text-primary-600': dragOverA}">
                                <i class="ph-fill text-4xl" :class="fileA ? 'ph-check-circle' : 'ph-microsoft-excel-logo'"></i>
                            </div>
                            
                            <div x-show="!fileA">
                                <h3 class="text-lg font-bold text-slate-800">직원 데이터 업로드</h3>
                                <p class="text-sm text-slate-500 mt-1">클릭하여 선택하거나 파일을 이곳에 드래그하세요</p>
                                <div class="mt-4 inline-flex items-center gap-2 px-3 py-1 bg-slate-100 rounded-full text-xs text-slate-500">
                                    <i class="ph-fill ph-file-xls"></i> .xlsx, .xls 지원
                                </div>
                            </div>

                            <div x-show="fileA">
                                <h3 class="text-lg font-bold text-slate-800" x-text="fileA?.name"></h3>
                                <p class="text-sm text-green-600 mt-1 font-medium">파일이 준비되었습니다</p>
                                <button @click.stop="fileA = null; document.getElementById('fileA').value = ''" class="mt-4 text-sm text-slate-400 hover:text-red-500 underline">
                                    취소하고 다시 선택
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Status Area -->
                    <div class="flex flex-col items-center gap-4">
                       <!-- 로딩 상태 표시 -->
                       <div x-show="isLoading" class="w-full py-4 bg-primary-100 text-primary-700 rounded-xl font-bold text-lg flex items-center justify-center gap-3">
                           <i class="ph-bold ph-spinner animate-spin"></i>
                           <span>분석 중입니다...</span>
                       </div>

                       <!-- Helper Text -->
                       <p class="text-sm text-slate-400" x-show="!isLoading && (!fileA || !selectedSavedRuleId)">
                           <i class="ph-fill ph-info mr-1"></i>
                           <span x-show="!selectedSavedRuleId">좌측 메뉴에서 규칙을 먼저 선택해주세요.</span>
                           <span x-show="selectedSavedRuleId && !fileA">데이터 파일을 업로드하면 자동으로 검증이 시작됩니다.</span>
                       </p>
                    </div>
                </div>
            </div>

            <!-- VIEW: DASHBOARD -->
            <div x-show="currentTab === 'dashboard'" x-cloak>
                <div x-show="!hasResults" class="text-center py-20">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-400">
                        <i class="ph ph-chart-bar text-4xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-slate-700 mb-2">아직 데이터가 없습니다</h3>
                    <p class="text-slate-500 mb-6">먼저 '파일 업로드' 메뉴에서 데이터를 검증해주세요.</p>
                    <button @click="currentTab = 'upload'" class="text-primary-600 font-medium hover:underline">업로드하러 가기 &rarr;</button>
                </div>

                <div x-show="hasResults" class="space-y-6">
                    
                    <!-- Matching Info Banner -->
                    <template x-if="results?.metadata?.matching_stats">
                        <div class="rounded-lg p-4 border"
                             :class="results.metadata.matching_stats.matched_sheets === results.metadata.matching_stats.total_rule_sheets 
                                     ? 'bg-blue-50 border-blue-200 text-blue-800' 
                                     : 'bg-orange-50 border-orange-200 text-orange-800'">
                            <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
                                <div class="flex items-start gap-3">
                                    <i class="ph-fill text-xl mt-0.5"
                                       :class="results.metadata.matching_stats.matched_sheets === results.metadata.matching_stats.total_rule_sheets 
                                               ? 'ph-check-circle text-blue-600' 
                                               : 'ph-warning-circle text-orange-600'"></i>
                                    <div>
                                        <h4 class="font-semibold text-sm mb-1 flex items-center">
                                            <span>
                                                시트 매칭 결과: 
                                                <span x-text="results.metadata.matching_stats.matched_sheets"></span> / 
                                                <span x-text="results.metadata.matching_stats.total_rule_sheets"></span> 시트 매칭됨
                                            </span>
                                        </h4>
                                        <p class="text-sm opacity-90">
                                            규칙 파일에 정의된 시트 중 
                                            <span class="font-bold" x-text="Math.round((results.metadata.matching_stats.matched_sheets / results.metadata.matching_stats.total_rule_sheets) * 100)"></span>%가 
                                            데이터 파일과 정상적으로 매칭되어 검증되었습니다.
                                        </p>
                                    </div>
                                </div>

                                <!-- Sheet Dropdowns -->
                                <div class="flex gap-2">
                                    <div class="relative group">
                                        <select class="appearance-none bg-white border border-slate-300 text-slate-700 py-1.5 pl-3 pr-8 rounded-lg text-xs font-medium focus:outline-none focus:ring-2 focus:ring-primary-500 cursor-pointer w-48">
                                            <option disabled selected x-text="'규칙(B) 시트 목록 (' + results.metadata.matching_stats.all_rule_sheets.length + ')'"></option>
                                            <template x-for="sheet in results.metadata.matching_stats.all_rule_sheets" :key="sheet">
                                                <option x-text="sheet"></option>
                                            </template>
                                        </select>
                                        <i class="ph ph-caret-down absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                    </div>

                                    <div class="relative group">
                                        <select class="appearance-none bg-white border border-slate-300 text-slate-700 py-1.5 pl-3 pr-8 rounded-lg text-xs font-medium focus:outline-none focus:ring-2 focus:ring-primary-500 cursor-pointer w-48">
                                            <option disabled selected x-text="'데이터(A) 시트 목록 (' + results.metadata.matching_stats.all_data_sheets.length + ')'"></option>
                                            <template x-for="sheet in results.metadata.matching_stats.all_data_sheets" :key="sheet">
                                                <option x-text="sheet"></option>
                                            </template>
                                        </select>
                                        <i class="ph ph-caret-down absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Missing Sheets List (Conditional) -->
                            <template x-if="results.metadata.matching_stats.unmatched_sheet_names && results.metadata.matching_stats.unmatched_sheet_names.length > 0">
                                <div class="mt-3 text-xs bg-white/60 p-2 rounded border border-orange-200/50">
                                    <span class="font-semibold text-orange-700">⚠️ 매칭되지 않은 규칙 시트:</span>
                                    <ul class="list-disc list-inside mt-1 space-y-0.5 text-orange-800">
                                        <template x-for="sheet in results.metadata.matching_stats.unmatched_sheet_names" :key="sheet">
                                            <li x-text="sheet"></li>
                                        </template>
                                    </ul>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- K-IFRS Summary Banner -->
                    <template x-if="kifrsSummaryErrors.length > 0">
                        <div class="rounded-lg p-4 border bg-amber-50 border-amber-200 text-amber-900">
                            <h4 class="font-bold text-sm mb-2 flex items-center gap-2">
                                <i class="ph-fill ph-info text-amber-600"></i>
                                K-IFRS 종합 분석 결과
                            </h4>
                            <ul class="space-y-2 text-sm list-disc list-inside pl-1">
                                <template x-for="err in kifrsSummaryErrors" :key="err.id || Math.random()">
                                    <li x-text="err.message"></li>
                                </template>
                            </ul>
                        </div>
                    </template>

                    <!-- Stat Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                            <div class="text-slate-500 text-sm font-medium mb-2">전체 데이터 행</div>
                            <div class="text-3xl font-bold text-slate-800" x-text="results?.summary?.total_rows.toLocaleString()"></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                            <div class="text-slate-500 text-sm font-medium mb-2">정상 데이터</div>
                            <div class="text-3xl font-bold text-green-600" x-text="results?.summary?.valid_rows.toLocaleString()"></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                            <div class="text-slate-500 text-sm font-medium mb-2">발견된 오류</div>
                            <div class="text-3xl font-bold text-red-500" x-text="results?.summary?.error_rows.toLocaleString()"></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                            <div class="text-slate-500 text-sm font-medium mb-2">규칙 준수율</div>
                            <div class="text-3xl font-bold text-primary-600">
                                <span x-text="calculateComplianceRate()"></span>%
                            </div>
                        </div>
                    </div>

                    <!-- Chart Section (Global) -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-slate-800 flex items-center gap-2">
                                <i class="ph-fill ph-chart-bar text-primary-500"></i>
                                전체 시트별 오류 분포
                            </h4>
                            <span class="text-xs text-slate-400">모든 시트의 오류 발생 현황을 보여줍니다</span>
                        </div>
                        <div class="h-64">
                            <canvas id="sheetChart"></canvas>
                        </div>
                    </div>

                    <!-- Dashboard Tabs -->
                    <div class="border-b border-slate-200 mb-6">
                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                            <button @click="dashboardTab = 'analysis'"
                                    :class="dashboardTab === 'analysis' 
                                        ? 'border-primary-500 text-primary-600' 
                                        : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2">
                                <i class="ph-fill ph-chart-bar"></i>
                                시트별 상세 분석
                            </button>
                            <button @click="dashboardTab = 'fix'"
                                    :class="dashboardTab === 'fix' 
                                        ? 'border-primary-500 text-primary-600' 
                                        : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'"
                                    class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2">
                                <i class="ph-fill ph-wrench"></i>
                                오류 항목 수정하기
                                <span x-show="hasFixableItems()" class="ml-2 bg-green-100 text-green-700 py-0.5 px-2 rounded-full text-xs">Available</span>
                            </button>
                        </nav>
                    </div>

                    <!-- Detailed Analysis Section with Tabs -->
                    <div class="space-y-4" x-show="selectedSheet && dashboardTab === 'analysis'">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                                <i class="ph-fill ph-list-magnifying-glass text-primary-600"></i>
                                시트별 상세 분석
                            </h3>
                        </div>

                        <!-- Sheet Tabs -->
                        <div class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar">
                            <template x-for="sheetName in (results?.metadata?.sheet_order || Object.keys(results?.metadata?.sheets_summary || {}))" :key="sheetName">
                                <button @click="selectedSheet = sheetName"
                                        class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all flex items-center gap-2 border"
                                        :class="selectedSheet === sheetName 
                                            ? 'bg-primary-600 text-white border-primary-600 shadow-md transform scale-105' 
                                            : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50 hover:border-slate-300'"
                                        x-show="results?.metadata?.sheets_summary[sheetName]"> <!-- Ensure sheet exists in summary -->
                                    <span x-text="sheetName"></span>
                                    <span class="text-xs px-1.5 py-0.5 rounded-full"
                                          :class="selectedSheet === sheetName
                                              ? 'bg-white/20 text-white'
                                              : (results.metadata.sheets_summary?.[sheetName]?.error_rows > 0 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600')"
                                          x-text="results.metadata.sheets_summary?.[sheetName]?.error_rows > 0 ? results.metadata.sheets_summary[sheetName].error_rows : 'OK'"></span>
                                </button>
                            </template>
                        </div>

                        <!-- Sheet Content Area -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            
                            <!-- Left Column: Stats & Summary -->
                            <div class="space-y-6">
                                <!-- Sheet Summary Card -->
                                <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5 h-full" x-data="{ summary: getSelectedSheetSummary() }">
                                    <div class="flex items-center justify-between mb-6">
                                        <h4 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                                            <i class="ph-fill ph-table text-slate-400"></i>
                                            <span x-text="selectedSheet"></span>
                                        </h4>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="bg-slate-50 rounded-lg p-4 border border-slate-100">
                                            <div class="text-slate-500 text-xs font-medium mb-1">전체 데이터</div>
                                            <div class="text-2xl font-bold text-slate-700" x-text="summary?.total_rows.toLocaleString()"></div>
                                        </div>
                                        <div class="bg-red-50 rounded-lg p-4 border border-red-100">
                                            <div class="text-red-600 text-xs font-medium mb-1">오류 데이터</div>
                                            <div class="text-2xl font-bold text-red-600" x-text="summary?.error_rows.toLocaleString()"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-6 pt-6 border-t border-slate-100">
                                        <div class="flex justify-between items-center text-sm text-slate-600">
                                            <span>오류율</span>
                                            <span class="font-bold" x-text="summary?.total_rows > 0 ? Math.round((summary.error_rows / summary.total_rows) * 100) + '%' : '0%'"></span>
                                        </div>
                                        <div class="w-full bg-slate-100 rounded-full h-2.5 mt-2 overflow-hidden">
                                            <div class="bg-red-500 h-2.5 rounded-full transition-all duration-500" 
                                                 :style="'width: ' + (summary?.total_rows > 0 ? (summary.error_rows / summary.total_rows) * 100 : 0) + '%'"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Right Column: Top 5 Issues -->
                            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-5 flex flex-col h-full">
                                <h4 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                                    <i class="ph-fill ph-warning text-orange-500"></i>
                                    <span>주요 인지 항목 (Top 5)</span>
                                </h4>
                                
                                <div class="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-1">
                                    <template x-for="(group, index) in getTopErrorsForSheet(selectedSheet)" :key="index">
                                        <div class="p-3 bg-slate-50 rounded-lg border-l-4 border-orange-400 hover:bg-orange-50/50 transition-colors">
                                            <div class="flex justify-between items-start mb-1.5">
                                                <span class="text-xs font-bold text-slate-600 bg-white border border-slate-200 px-1.5 py-0.5 rounded" x-text="group.column"></span>
                                                <span class="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold whitespace-nowrap" x-text="group.count + '건'"></span>
                                            </div>
                                            <p class="text-sm text-slate-700 leading-snug" x-text="group.message"></p>
                                            
                                            <!-- Sample Values -->
                                            <div class="mt-2 pt-2 border-t border-slate-200/50 flex gap-1 overflow-x-auto">
                                                <template x-for="val in group.sample_values" :key="val">
                                                    <span class="text-[10px] font-mono bg-white text-slate-500 px-1 rounded border border-slate-200 whitespace-nowrap" x-text="val"></span>
                                                </template>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <div x-show="getTopErrorsForSheet(selectedSheet).length === 0" class="flex flex-col items-center justify-center h-40 text-slate-400">
                                        <i class="ph ph-check-circle text-4xl mb-2 text-green-100"></i>
                                        <span class="text-sm">발견된 오류가 없습니다.</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Error Fix Section with Tabs (오류 항목 수정하기) -->
                    <div x-show="dashboardTab === 'fix'">
                        <div x-show="!hasFixableItems()" class="text-center py-12 bg-slate-50 rounded-xl border border-slate-200 border-dashed">
                            <i class="ph ph-check-circle text-4xl text-slate-300 mb-3"></i>
                            <p class="text-slate-500 font-medium">수정 가능한 오류 항목이 없습니다.</p>
                            <p class="text-sm text-slate-400 mt-1">모든 데이터가 정상이거나, 자동 수정이 불가능한 항목입니다.</p>
                        </div>

                        <template x-if="hasFixableItems()">
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <!-- Section Header -->
                            <div class="flex items-center justify-between p-4 border-b border-slate-200 bg-slate-50">
                                <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                    <i class="ph-fill ph-wrench text-amber-500"></i>
                                    오류 항목 수정하기
                                </h3>
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="text-slate-500">선택:</span>
                                    <span class="font-bold text-indigo-600" x-text="selectedFixItems.length"></span>
                                    <span class="text-slate-400">개 /</span>
                                    <span class="font-bold text-indigo-600" x-text="getSelectedFixCount()"></span>
                                    <span class="text-slate-400">건</span>
                                </div>
                            </div>

                            <!-- Tab Navigation -->
                            <div class="flex border-b border-slate-200">
                                <button @click="fixActiveTab = 'before'"
                                        class="flex-1 px-4 py-3 text-sm font-medium transition-colors relative"
                                        :class="fixActiveTab === 'before'
                                            ? 'text-indigo-600 bg-white'
                                            : 'text-slate-500 hover:text-slate-700 bg-slate-50'">
                                    <span class="flex items-center justify-center gap-2">
                                        <i class="ph ph-list-checks"></i>
                                        수정 전 (항목 선택)
                                    </span>
                                    <div x-show="fixActiveTab === 'before'"
                                         class="absolute bottom-0 left-0 right-0 h-0.5 bg-indigo-600"></div>
                                </button>
                                <button @click="fixActiveTab = 'after'; generateFixPreview()"
                                        class="flex-1 px-4 py-3 text-sm font-medium transition-colors relative"
                                        :class="fixActiveTab === 'after'
                                            ? 'text-indigo-600 bg-white'
                                            : 'text-slate-500 hover:text-slate-700 bg-slate-50'"
                                        :disabled="selectedFixItems.length === 0">
                                    <span class="flex items-center justify-center gap-2">
                                        <i class="ph ph-eye"></i>
                                        수정 후 (미리보기)
                                        <span x-show="selectedFixItems.length > 0"
                                              class="px-1.5 py-0.5 text-xs rounded-full bg-indigo-100 text-indigo-600"
                                              x-text="getSelectedFixCount() + '건'"></span>
                                    </span>
                                    <div x-show="fixActiveTab === 'after'"
                                         class="absolute bottom-0 left-0 right-0 h-0.5 bg-indigo-600"></div>
                                </button>
                            </div>

                            <!-- Tab Content: Before (항목 선택) -->
                            <div x-show="fixActiveTab === 'before'" class="p-4">
                                <!-- Filters -->
                                <div class="flex flex-wrap items-center gap-2 mb-4">
                                    <button @click="selectAllFixableItems()"
                                            class="px-3 py-1.5 text-xs font-medium rounded-lg border border-slate-300 hover:bg-slate-50 transition-colors">
                                        <i class="ph ph-checks mr-1"></i>전체 선택
                                    </button>
                                    <button @click="selectedFixItems = []"
                                            class="px-3 py-1.5 text-xs font-medium rounded-lg border border-slate-300 hover:bg-slate-50 transition-colors"
                                            :disabled="selectedFixItems.length === 0">
                                        <i class="ph ph-x mr-1"></i>선택 해제
                                    </button>
                                    <div class="flex-1"></div>
                                    <select x-model="fixFilterSheet"
                                            class="text-xs border border-slate-300 rounded-lg px-2 py-1.5 bg-white">
                                        <option value="all">모든 시트</option>
                                        <template x-for="sheet in getUniqueSheets()" :key="sheet">
                                            <option :value="sheet" x-text="sheet"></option>
                                        </template>
                                    </select>
                                </div>

                                <!-- Error List -->
                                <div class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar">
                                    <template x-for="(group, idx) in getFilteredErrorsBySheetAndColumn()" :key="group.key">
                                        <div @click="toggleFixItem(group.key, group.autoFixable)"
                                             class="flex items-start gap-3 p-3 rounded-lg border transition-all"
                                             :class="group.autoFixable
                                                 ? (isFixItemSelected(group.key) ? 'border-indigo-500 bg-indigo-50 cursor-pointer' : 'border-slate-200 hover:border-indigo-300 hover:bg-slate-50 cursor-pointer')
                                                 : 'border-slate-100 bg-slate-50 cursor-not-allowed opacity-60'">
                                            <input type="checkbox"
                                                   :checked="isFixItemSelected(group.key)"
                                                   :disabled="!group.autoFixable"
                                                   @click.stop="toggleFixItem(group.key, group.autoFixable)"
                                                   class="mt-1 w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500">
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 flex-wrap">
                                                    <span class="text-xs px-2 py-0.5 rounded bg-slate-200 text-slate-700 font-medium" x-text="group.sheet"></span>
                                                    <span class="font-semibold text-slate-800" x-text="group.column"></span>
                                                    <span class="text-xs px-2 py-0.5 rounded-full"
                                                          :class="group.autoFixable ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                                                          x-text="group.autoFixable ? group.fixDescription : '자동수정 불가'"></span>
                                                </div>
                                                <div class="flex items-center gap-4 mt-1">
                                                    <span class="text-xs font-medium text-indigo-600" x-text="group.count + '건'"></span>
                                                    <span class="text-xs text-slate-400" x-show="group.sampleValues.length > 0">
                                                        예시: <span x-text="group.sampleValues.slice(0, 2).map(v => '\"' + v + '\"').join(', ')"></span>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </template>

                                    <div x-show="getFilteredErrorsBySheetAndColumn().length === 0"
                                         class="text-center py-8 text-slate-400">
                                        <i class="ph ph-funnel text-3xl mb-2"></i>
                                        <p class="text-sm">필터 조건에 맞는 항목이 없습니다.</p>
                                    </div>
                                </div>

                                <!-- Bottom Guide -->
                                <div class="mt-4 pt-4 border-t border-slate-200 text-center text-sm text-slate-500">
                                    <i class="ph ph-arrow-right mr-1"></i>
                                    항목을 선택한 후 <span class="font-medium text-indigo-600">"수정 후"</span> 탭에서 결과를 확인하세요.
                                </div>
                            </div>

                            <!-- Tab Content: After (미리보기) -->
                            <div x-show="fixActiveTab === 'after'" class="p-4">
                                <!-- No Selection Warning -->
                                <div x-show="selectedFixItems.length === 0" class="text-center py-12">
                                    <i class="ph ph-cursor-click text-4xl text-slate-300 mb-3"></i>
                                    <p class="text-slate-500">"수정 전" 탭에서 수정할 항목을 먼저 선택해주세요.</p>
                                </div>

                                <!-- Preview Content -->
                                <div x-show="selectedFixItems.length > 0">
                                    <!-- Summary Stats -->
                                    <div class="grid grid-cols-4 gap-3 mb-4">
                                        <div class="bg-slate-50 rounded-lg p-3 text-center">
                                            <div class="text-2xl font-bold text-slate-700" x-text="fixPreview.total || 0"></div>
                                            <div class="text-xs text-slate-500">총 대상</div>
                                        </div>
                                        <div class="bg-green-50 rounded-lg p-3 text-center">
                                            <div class="text-2xl font-bold text-green-600" x-text="fixPreview.success || 0"></div>
                                            <div class="text-xs text-green-600">수정 성공</div>
                                        </div>
                                        <div class="bg-red-50 rounded-lg p-3 text-center">
                                            <div class="text-2xl font-bold text-red-500" x-text="fixPreview.fail || 0"></div>
                                            <div class="text-xs text-red-500">수정 실패</div>
                                        </div>
                                        <div class="bg-indigo-50 rounded-lg p-3 text-center">
                                            <div class="text-2xl font-bold text-indigo-600" x-text="(fixPreview.successRate || 0) + '%'"></div>
                                            <div class="text-xs text-indigo-600">성공률</div>
                                        </div>
                                    </div>

                                    <!-- Download Button (Moved to Top) -->
                                    <div class="mb-4 p-4 bg-indigo-50 rounded-xl border border-indigo-100 flex items-center justify-between shadow-sm">
                                        <div class="text-sm text-indigo-700">
                                            <i class="ph-fill ph-info mr-1"></i>
                                            <span class="font-semibold" x-text="fixPreview.success"></span>건 수정 가능. 
                                            수정된 셀은 <span class="bg-yellow-200 px-1 rounded">노란색</span>으로 표시됩니다.
                                        </div>
                                        <button @click="downloadFixedFile()"
                                                class="px-6 py-2.5 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition-all flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-md shadow-indigo-200"
                                                :disabled="isDownloading || fixPreview.success === 0">
                                            <i class="ph ph-download-simple text-lg"></i>
                                            <span x-text="isDownloading ? '생성 중...' : '수정 파일 다운로드'"></span>
                                        </button>
                                    </div>

                                    <!-- Filter -->
                                    <div class="flex items-center gap-2 mb-3">
                                        <select x-model="fixPreviewFilter"
                                                class="text-xs border border-slate-300 rounded-lg px-2 py-1.5 bg-white">
                                            <option value="all">전체 보기</option>
                                            <option value="success">성공만 보기</option>
                                            <option value="fail">실패만 보기</option>
                                        </select>
                                        <span class="text-xs text-slate-400" x-text="'표시: ' + getFilteredPreviewItems().length + '건'"></span>
                                    </div>

                                    <!-- Preview Table -->
                                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                                        <table class="w-full text-sm">
                                            <thead class="bg-slate-50 text-slate-600">
                                                <tr>
                                                    <th class="px-3 py-2 text-left font-medium">시트</th>
                                                    <th class="px-3 py-2 text-left font-medium">컬럼</th>
                                                    <th class="px-3 py-2 text-left font-medium">행</th>
                                                    <th class="px-3 py-2 text-left font-medium">수정 전</th>
                                                    <th class="px-3 py-2 text-center font-medium"></th>
                                                    <th class="px-3 py-2 text-left font-medium">수정 후</th>
                                                    <th class="px-3 py-2 text-center font-medium">상태</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-slate-100 max-h-60 overflow-y-auto">
                                                <template x-for="(item, idx) in getFilteredPreviewItems().slice(0, 50)" :key="idx">
                                                    <tr class="hover:bg-slate-50">
                                                        <td class="px-3 py-2 text-xs text-slate-500" x-text="item.sheet"></td>
                                                        <td class="px-3 py-2 font-medium text-slate-700" x-text="item.column"></td>
                                                        <td class="px-3 py-2 text-slate-500" x-text="item.row"></td>
                                                        <td class="px-3 py-2">
                                                            <span class="px-2 py-1 bg-red-50 text-red-600 rounded text-xs font-mono" x-text="item.before"></span>
                                                        </td>
                                                        <td class="px-3 py-2 text-center">
                                                            <i class="ph ph-arrow-right text-slate-300"></i>
                                                        </td>
                                                        <td class="px-3 py-2">
                                                            <span class="px-2 py-1 rounded text-xs font-mono"
                                                                  :class="item.success ? 'bg-green-50 text-green-600' : 'bg-slate-100 text-slate-400'"
                                                                  x-text="item.after"></span>
                                                        </td>
                                                        <td class="px-3 py-2 text-center">
                                                            <i class="ph-fill"
                                                               :class="item.success ? 'ph-check-circle text-green-500' : 'ph-x-circle text-red-400'"></i>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                        <div x-show="getFilteredPreviewItems().length > 50"
                                             class="px-3 py-2 bg-slate-50 text-xs text-slate-500 text-center border-t border-slate-200">
                                            ... 외 <span x-text="getFilteredPreviewItems().length - 50"></span>건 더 있음
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </template>
                    </div>

                </div>
            </div>

            <!-- VIEW: REPORT (Details) -->
            <div x-show="currentTab === 'report'" x-cloak>
                <div x-show="!hasResults" class="text-center py-20">
                     <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-400">
                        <i class="ph ph-files text-4xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-slate-700 mb-2">분석 결과가 없습니다</h3>
                    <button @click="currentTab = 'upload'" class="text-primary-600 font-medium hover:underline">업로드 화면으로 이동</button>
                </div>

                <div x-show="hasResults" class="space-y-4">
                    <div class="flex flex-col lg:flex-row justify-between items-stretch lg:items-center gap-4 bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                        <div class="flex flex-col sm:flex-row gap-2 flex-1">
                            <div class="relative flex-1">
                                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                <input type="text" x-model="searchQuery" @input="currentPage = 1" placeholder="오류 검색..." 
                                       class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent text-sm">
                            </div>
                            
                            <select x-model="filterSheet" @change="currentPage = 1"
                                    class="px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 text-sm bg-white">
                                <option value="all">모든 시트</option>
                                <template x-for="sheet in (results?.metadata?.sheet_order || Object.keys(results?.metadata?.sheets_summary || {}))" :key="sheet">
                                    <option :value="sheet" x-text="sheet" x-show="results?.metadata?.sheets_summary[sheet]"></option>
                                </template>
                            </select>
                        </div>

                        <div class="flex items-center gap-2">
                            <button @click="openSmartFixTab" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-sm text-sm">
                                <i class="ph-fill ph-magic-wand"></i>
                                <span>AI 수정 제안</span>
                            </button>
                            <button @click="downloadExcel" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors shadow-sm text-sm">
                                <i class="ph ph-file-xls text-lg"></i>
                                <span>Excel</span>
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                                    <tr>
                                        <th class="px-6 py-4">위치</th>
                                        <th class="px-6 py-4">항목</th>
                                        <th class="px-6 py-4">오류 내용</th>
                                        <th class="px-6 py-4">값 (실제/예상)</th>
                                        <th class="px-6 py-4">작업</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <template x-for="error in filteredErrors" :key="error.id || Math.random()">
                                        <tr class="hover:bg-slate-50 transition-colors">
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="font-medium text-slate-900" x-text="error.sheet"></div>
                                                <div class="text-xs text-slate-500" x-text="error.row > 0 ? 'Row ' + error.row : '요약'"></div>
                                            </td>
                                            <td class="px-6 py-4 font-medium text-slate-700" x-text="error.column"></td>
                                            <td class="px-6 py-4 text-slate-600">
                                                <div class="flex items-center gap-2">
                                                    <span x-text="error.message"></span>
                                                    <span x-show="error.rule_id && error.rule_id.startsWith('KIFRS_')" class="px-1.5 py-0.5 text-[10px] font-bold text-sky-700 bg-sky-100 border border-sky-200 rounded">K-IFRS</span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-2">
                                                    <span class="px-2 py-1 bg-red-50 text-red-600 rounded text-xs font-mono" x-text="error.actual_value"></span>
                                                    <i class="ph ph-arrow-right text-slate-300 text-xs" x-show="error.expected"></i>
                                                    <span class="px-2 py-1 bg-green-50 text-green-600 rounded text-xs font-mono" x-show="error.expected" x-text="error.expected"></span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-3">
                                                    <button @click="getAIExplanation(error)" class="flex items-center gap-1 px-2 py-1 bg-indigo-50 text-indigo-600 rounded-md hover:bg-indigo-100 transition-colors text-xs font-semibold">
                                                        <i class="ph-fill ph-magic-wand"></i>
                                                        <span>AI 분석</span>
                                                    </button>
                                                    <button x-show="error.id" @click="openFeedbackModal(error)" class="text-slate-400 hover:text-orange-500 transition-colors" title="오류 신고">
                                                        <i class="ph ph-flag"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                    <tr x-show="filteredErrors.length === 0">
                                        <td colspan="5" class="px-6 py-12 text-center text-slate-500">
                                            검색 결과가 없습니다.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination Controls -->
                        <div class="bg-slate-50 px-6 py-4 border-t border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div class="text-xs text-slate-500">
                                <span x-text="'표시: ' + ((currentPage-1)*pageSize + 1) + '-' + Math.min(currentPage*pageSize, totalFiltered) + ' / 전체 ' + totalFiltered + ' 건'"></span>
                            </div>
                            
                            <div class="flex items-center gap-1">
                                <button @click="currentPage = 1" :disabled="currentPage === 1" 
                                        class="p-2 rounded hover:bg-white disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                                    <i class="ph ph-caret-double-left"></i>
                                </button>
                                <button @click="currentPage--" :disabled="currentPage === 1" 
                                        class="p-2 rounded hover:bg-white disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                                    <i class="ph ph-caret-left"></i>
                                </button>
                                
                                <div class="flex items-center gap-1 px-2">
                                    <template x-for="p in Array.from({length: Math.min(5, totalPages)}, (_, i) => {
                                        if (totalPages <= 5) return i + 1;
                                        let start = Math.max(1, currentPage - 2);
                                        let end = Math.min(totalPages, start + 4);
                                        if (end === totalPages) start = Math.max(1, end - 4);
                                        return start + i;
                                    })" :key="p">
                                        <button @click="currentPage = p" 
                                                class="w-8 h-8 rounded text-sm font-medium transition-colors"
                                                :class="currentPage === p ? 'bg-primary-600 text-white' : 'hover:bg-white text-slate-600'"
                                                x-text="p"></button>
                                    </template>
                                </div>

                                <button @click="currentPage++" :disabled="currentPage === totalPages" 
                                        class="p-2 rounded hover:bg-white disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                                    <i class="ph ph-caret-right"></i>
                                </button>
                                <button @click="currentPage = totalPages" :disabled="currentPage === totalPages" 
                                        class="p-2 rounded hover:bg-white disabled:opacity-30 disabled:cursor-not-allowed transition-colors">
                                    <i class="ph ph-caret-double-right"></i>
                                </button>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-500">페이지당:</span>
                                <select x-model="pageSize" @change="currentPage = 1" class="text-xs border border-slate-200 rounded p-1 bg-white">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feedback Modal -->
                <div x-show="feedbackModalOpen" x-cloak class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6" @click.stop>
                        <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                            <i class="ph-fill ph-flag text-orange-500"></i>
                            오류 신고 (False Positive)
                        </h3>
                        <div class="space-y-4">
                            <div class="bg-slate-50 p-3 rounded-lg text-sm space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-slate-500">규칙 ID:</span>
                                    <span class="font-mono font-medium" x-text="selectedError?.rule_id"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-500">메시지:</span>
                                    <span class="font-medium text-right" x-text="selectedError?.message"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-500">입력값:</span>
                                    <span class="font-mono text-red-600" x-text="selectedError?.actual_value"></span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">신고 사유</label>
                                <textarea x-model="feedbackReason" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 h-24" placeholder="왜 이 항목이 오류가 아닌지 설명해주세요."></textarea>
                            </div>
                            
                            <div class="flex gap-3 justify-end pt-2">
                                <button @click="feedbackModalOpen = false" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">취소</button>
                                <button @click="submitFeedback" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">신고하기</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Explanation Modal -->
                <div x-show="aiExplanationModalOpen" x-cloak class="fixed inset-0 bg-black/50 z-[90] flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full" @click.stop>
                        <div class="p-6 border-b border-slate-100">
                            <h3 class="text-lg font-bold text-slate-900 flex items-center gap-2">
                                <i class="ph-fill ph-brain text-indigo-500"></i>
                                <span x-text="currentExplanation.title"></span>
                            </h3>
                        </div>
                        <div class="p-6 space-y-5 max-h-[60vh] overflow-y-auto">
                            <div x-show="isExplanationLoading" class="flex items-center justify-center py-10">
                                <i class="ph-bold ph-spinner animate-spin text-3xl text-indigo-500"></i>
                            </div>
                            <div x-show="!isExplanationLoading" class="space-y-5">
                                <div>
                                    <h4 class="font-semibold text-slate-700 mb-2 flex items-center gap-1.5">
                                        <i class="ph-fill ph-question text-slate-400"></i>
                                        오류 설명
                                    </h4>
                                    <p class="text-slate-600 leading-relaxed bg-slate-50 p-4 rounded-lg border border-slate-200" x-text="currentExplanation.explanation"></p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-slate-700 mb-2 flex items-center gap-1.5">
                                        <i class="ph-fill ph-wrench text-slate-400"></i>
                                        권장 조치
                                    </h4>
                                    <p class="text-slate-600 leading-relaxed bg-slate-50 p-4 rounded-lg border border-slate-200" x-text="currentExplanation.recommendation"></p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-4 flex justify-end">
                            <button @click="aiExplanationModalOpen = false" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 transition-colors text-sm font-medium">
                                닫기
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: LEARNING DASHBOARD -->
            <div x-show="currentTab === 'learning'" x-cloak x-init="$watch('currentTab', val => { if(val === 'learning') loadLearningStats() })">
                <div class="max-w-7xl mx-auto space-y-6">
                    
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                                <i class="ph-fill ph-brain text-purple-600"></i>
                                AI 학습 현황
                            </h2>
                            <p class="text-slate-500 mt-1">사용자 피드백을 통해 학습된 규칙 패턴과 성능을 모니터링합니다.</p>
                        </div>
                        <button @click="loadLearningStats()" class="p-2 text-slate-400 hover:text-slate-600 rounded-lg hover:bg-slate-100 transition-colors">
                            <i class="ph ph-arrows-clockwise text-xl"></i>
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div x-show="!learningStats" class="flex flex-col items-center justify-center py-20">
                        <i class="ph-bold ph-spinner animate-spin text-4xl text-purple-500 mb-4"></i>
                        <p class="text-slate-500">학습 데이터를 불러오는 중...</p>
                    </div>

                    <div x-show="learningStats" class="space-y-6">
                        <!-- Stat Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                <div class="text-slate-500 text-sm font-medium mb-2">학습된 패턴</div>
                                <div class="text-3xl font-bold text-slate-800" x-text="learningStats?.total_patterns || 0"></div>
                                <div class="text-xs text-slate-400 mt-1">
                                    <span x-text="learningStats?.active_patterns || 0"></span>개 활성 패턴
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                <div class="text-slate-500 text-sm font-medium mb-2">패턴 사용 횟수</div>
                                <div class="text-3xl font-bold text-purple-600" x-text="learningStats?.total_usage || 0"></div>
                            </div>
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                <div class="text-slate-500 text-sm font-medium mb-2">평균 신뢰도</div>
                                <div class="text-3xl font-bold text-slate-800">
                                    <span x-text="Math.round((learningStats?.avg_confidence || 0) * 100)"></span>%
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                                <div class="text-slate-500 text-sm font-medium mb-2">적중률 (성공)</div>
                                <div class="text-3xl font-bold text-green-600">
                                    <span x-text="Math.round((learningStats?.success_rate || 0) * 100)"></span>%
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Top Patterns -->
                            <div class="lg:col-span-2 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                                <div class="p-6 border-b border-slate-100">
                                    <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                        <i class="ph-fill ph-star text-yellow-500"></i>
                                        주요 학습 패턴 (Top 10)
                                    </h3>
                                </div>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-slate-50 text-slate-500 font-medium">
                                            <tr>
                                                <th class="px-6 py-3 text-left">원본 규칙 (예시)</th>
                                                <th class="px-6 py-3 text-left">AI 해석 유형</th>
                                                <th class="px-6 py-3 text-center">사용</th>
                                                <th class="px-6 py-3 text-center">신뢰도</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-100">
                                            <template x-for="pattern in learningStats?.top_patterns || []" :key="pattern.id">
                                                <tr class="hover:bg-slate-50 transition-colors">
                                                    <td class="px-6 py-4">
                                                        <div class="truncate max-w-xs text-slate-700" x-text="pattern.text_preview"></div>
                                                    </td>
                                                    <td class="px-6 py-4">
                                                        <span class="px-2 py-1 bg-purple-50 text-purple-700 rounded text-xs font-medium" x-text="pattern.rule_type"></span>
                                                    </td>
                                                    <td class="px-6 py-4 text-center text-slate-600" x-text="pattern.usage_count"></td>
                                                    <td class="px-6 py-4">
                                                        <div class="flex items-center justify-center gap-2">
                                                            <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                                                <div class="h-full bg-green-500 rounded-full" :style="'width: ' + (pattern.confidence * 100) + '%'"></div>
                                                            </div>
                                                            <span class="text-xs text-slate-500" x-text="Math.round(pattern.confidence * 100) + '%'"></span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                            <tr x-show="!learningStats?.top_patterns?.length">
                                                <td colspan="4" class="px-6 py-10 text-center text-slate-400">
                                                    학습된 패턴이 없습니다.
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Recent Feedback -->
                            <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6 flex flex-col h-full">
                                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <i class="ph-fill ph-clock-counter-clockwise text-blue-500"></i>
                                    최근 피드백
                                </h3>
                                <div class="flex-1 overflow-y-auto space-y-4 pr-2 custom-scrollbar max-h-[400px]">
                                    <template x-for="feed in learningStats?.recent_feedback || []" :key="feed.id">
                                        <div class="flex gap-3">
                                            <div class="mt-1">
                                                <div class="w-2 h-2 rounded-full" 
                                                     :class="feed.feedback_type === 'success' ? 'bg-green-500' : 
                                                             feed.feedback_type === 'false_positive' ? 'bg-orange-500' : 'bg-red-500'"></div>
                                            </div>
                                            <div class="flex-1 pb-4 border-b border-slate-50 last:border-0 last:pb-0">
                                                <div class="flex justify-between items-start mb-1">
                                                    <span class="text-xs font-bold uppercase" 
                                                          :class="feed.feedback_type === 'success' ? 'text-green-600' : 
                                                                  feed.feedback_type === 'false_positive' ? 'text-orange-600' : 'text-red-600'"
                                                          x-text="feed.feedback_type"></span>
                                                    <span class="text-[10px] text-slate-400" x-text="new Date(feed.created_at).toLocaleDateString()"></span>
                                                </div>
                                                <p class="text-xs text-slate-600" x-show="feed.details && feed.details.user_explanation" x-text="feed.details.user_explanation"></p>
                                                <p class="text-xs text-slate-400 mt-1" x-show="feed.details && !feed.details.user_explanation">
                                                    <span x-show="feed.feedback_type === 'success'">검증 성공 (오류율 < 5%)</span>
                                                    <span x-show="feed.feedback_type === 'false_positive'">사용자 신고</span>
                                                </p>
                                            </div>
                                        </div>
                                    </template>
                                    <div x-show="!learningStats?.recent_feedback?.length" class="text-center py-10 text-slate-400 text-sm">
                                        최근 피드백 내역이 없습니다.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: RULES MANAGEMENT (REDESIGNED) -->
            <div x-show="currentTab === 'rules'" x-cloak x-init="if(currentTab === 'rules') loadRuleFiles()">
                <div class="max-w-7xl mx-auto space-y-6">

                    <!-- Header with Step Indicator -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                                    <i class="ph-fill ph-gear-six text-primary-600"></i>
                                    규칙 관리
                                </h2>
                                <p class="text-slate-500 mt-1">검증 규칙을 업로드하고 AI 매핑을 검토하세요</p>
                            </div>
                        </div>

                        <!-- Step Indicator (2 Steps) -->
                        <div class="flex items-center justify-center gap-2 mb-4">
                            <template x-for="(step, idx) in [{num: 1, label: '파일 선택'}, {num: 2, label: '규칙 매핑 편집'}]" :key="step.num">
                                <div class="flex items-center">
                                    <button @click="ruleManagementStep = step.num"
                                            :disabled="step.num === 2 && !selectedRuleFile"
                                            class="flex items-center gap-2 px-4 py-2 rounded-lg transition-all"
                                            :class="ruleManagementStep === step.num ? 'bg-primary-600 text-white shadow-lg' :
                                                   (step.num < ruleManagementStep ? 'bg-green-100 text-green-700 hover:bg-green-200' :
                                                   'bg-slate-100 text-slate-500 hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed')">
                                        <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold"
                                              :class="step.num < ruleManagementStep ? 'bg-green-500 text-white' :
                                                      (ruleManagementStep === step.num ? 'bg-white text-primary-600' : 'bg-slate-300 text-slate-600')"
                                              x-text="step.num < ruleManagementStep ? '✓' : step.num"></span>
                                        <span class="font-medium hidden sm:inline" x-text="step.label"></span>
                                    </button>
                                    <div x-show="idx < 1" class="w-8 h-0.5 mx-1" :class="step.num < ruleManagementStep ? 'bg-green-400' : 'bg-slate-200'"></div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Step 1: File Upload/Selection -->
                    <div x-show="ruleManagementStep === 1" class="space-y-6">
                        <!-- Upload Section -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center">
                                    <i class="ph ph-upload-simple text-primary-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-slate-900">새 규칙 파일 업로드</h3>
                                    <p class="text-sm text-slate-500">Excel 규칙 파일을 업로드하면 자동으로 AI 해석이 진행됩니다</p>
                                </div>
                            </div>

                            <div class="grid lg:grid-cols-2 gap-6">
                                <div class="space-y-4">
                                    <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:border-primary-400 hover:bg-primary-50/30 transition-all cursor-pointer"
                                         @click="$refs.ruleFileInputNew.click()">
                                        <input type="file" x-ref="ruleFileInputNew" accept=".xlsx,.xls" @change="handleRuleFileSelect($event)" class="hidden">
                                        <i class="ph ph-file-xls text-4xl text-slate-400 mb-2"></i>
                                        <p class="text-slate-600 font-medium" x-text="ruleFileToUpload ? ruleFileToUpload.name : '클릭하여 파일 선택'"></p>
                                        <p class="text-xs text-slate-400 mt-1">.xlsx, .xls 파일 지원</p>
                                    </div>
                                </div>
                                <div class="space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-medium text-slate-600 mb-1">파일 버전</label>
                                            <input type="text" x-model="ruleFileVersion" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500" placeholder="1.0">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-600 mb-1">업로드자</label>
                                            <input type="text" x-model="ruleFileUploadedBy" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500" placeholder="system">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-600 mb-1">비고 (선택)</label>
                                        <input type="text" x-model="ruleFileNotes" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary-500" placeholder="파일에 대한 메모">
                                    </div>
                                    <button @click="uploadRuleFileToDb" :disabled="!ruleFileToUpload || uploadingRuleFile"
                                            class="w-full px-4 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-colors font-medium flex items-center justify-center gap-2">
                                        <i class="ph ph-cloud-arrow-up text-lg" x-show="!uploadingRuleFile"></i>
                                        <i class="ph ph-circle-notch text-lg animate-spin" x-show="uploadingRuleFile"></i>
                                        <span x-text="uploadingRuleFile ? '업로드 및 AI 해석 중...' : '업로드 및 AI 해석 시작'"></span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Saved Rules List -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i class="ph ph-database text-green-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-slate-900">저장된 규칙 파일</h3>
                                        <p class="text-sm text-slate-500" x-text="ruleFiles.length + '개 파일'"></p>
                                    </div>
                                </div>
                                <button @click="loadRuleFiles" class="p-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors">
                                    <i class="ph ph-arrows-clockwise text-lg"></i>
                                </button>
                            </div>

                            <div class="space-y-2" x-show="ruleFiles.length > 0">
                                <template x-for="file in ruleFiles" :key="file.id">
                                    <div class="border border-slate-200 rounded-lg p-4 hover:border-primary-400 hover:shadow-md transition-all cursor-pointer"
                                         :class="selectedRuleFile === file.id ? 'border-primary-500 bg-primary-50 shadow-md' : ''"
                                         @click="selectRuleFile(file.id)">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 rounded-lg flex items-center justify-center"
                                                     :class="selectedRuleFile === file.id ? 'bg-primary-600 text-white' : 'bg-slate-100 text-slate-500'">
                                                    <i class="ph ph-file-xls text-xl"></i>
                                                </div>
                                                <div>
                                                    <div class="flex items-center gap-2">
                                                        <h4 class="font-semibold text-slate-900" x-text="file.file_name"></h4>
                                                        <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 text-[10px] rounded" x-text="'v' + file.file_version"></span>
                                                    </div>
                                                    <div class="flex items-center gap-3 text-xs text-slate-500 mt-1">
                                                        <span><i class="ph ph-list-checks mr-1"></i><span x-text="file.total_rules_count"></span> 규칙</span>
                                                        <span><i class="ph ph-stack mr-1"></i><span x-text="file.sheet_count"></span> 시트</span>
                                                        <span><i class="ph ph-calendar mr-1"></i><span x-text="new Date(file.uploaded_at).toLocaleDateString()"></span></span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-1" @click.stop>
                                                <button @click="downloadRuleFile(file.id, file.file_name)" class="p-2 text-slate-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition-colors" title="다운로드">
                                                    <i class="ph ph-download-simple"></i>
                                                </button>
                                                <button @click="archiveRuleFile(file.id)" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="삭제">
                                                    <i class="ph ph-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <div x-show="ruleFiles.length === 0" class="text-center py-8 text-slate-400">
                                <i class="ph ph-files text-4xl mb-2"></i>
                                <p>저장된 규칙 파일이 없습니다</p>
                            </div>

                            <!-- Next Step Button -->
                            <div x-show="selectedRuleFile" class="mt-4 pt-4 border-t border-slate-100">
                                <button @click="goToMappingReview()" class="w-full px-4 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium flex items-center justify-center gap-2">
                                    <span>매핑 검토로 이동</span>
                                    <i class="ph ph-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Rule Mapping Edit (Integrated) -->
                    <div x-show="ruleManagementStep === 2" class="space-y-4">
                        <!-- Mapping Statistics -->
                        <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h3 class="text-lg font-bold text-slate-900" x-text="ruleMappings?.file_name || '규칙 파일'"></h3>
                                    <p class="text-sm text-slate-500">원본 규칙과 AI 해석 결과를 검토하고 수정하세요</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button @click="openCreateRuleModal()" class="px-3 py-2 text-sm bg-green-600 text-white hover:bg-green-700 rounded-lg transition-colors flex items-center gap-1">
                                        <i class="ph ph-plus"></i>
                                        <span>규칙 추가</span>
                                    </button>
                                    <button @click="reinterpretRulesAndRefresh()" class="px-3 py-2 text-sm bg-amber-100 hover:bg-amber-200 text-amber-700 rounded-lg transition-colors flex items-center gap-1" title="전체 규칙을 다시 AI 해석합니다">
                                        <i class="ph ph-arrows-clockwise"></i>
                                        <span>전체 재해석</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Stats Cards -->
                            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4" x-show="ruleMappings">
                                <div class="bg-slate-50 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-slate-800" x-text="ruleMappings?.statistics?.total_rules || 0"></div>
                                    <div class="text-xs text-slate-500">전체 규칙</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-green-600" x-text="ruleMappings?.statistics?.mapped_count || 0"></div>
                                    <div class="text-xs text-green-600">매핑 완료</div>
                                </div>
                                <div class="bg-amber-50 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-amber-600" x-text="ruleMappings?.statistics?.partial_count || 0"></div>
                                    <div class="text-xs text-amber-600">부분 매핑</div>
                                </div>
                                <div class="bg-red-50 rounded-lg p-3 text-center">
                                    <div class="text-2xl font-bold text-red-600" x-text="ruleMappings?.statistics?.unmapped_count || 0"></div>
                                    <div class="text-xs text-red-600">미매핑</div>
                                </div>
                            </div>

                            <!-- Progress Bar -->
                            <div class="mb-4" x-show="ruleMappings">
                                <div class="flex items-center justify-between text-xs text-slate-500 mb-1">
                                    <span>매핑률</span>
                                    <span x-text="(ruleMappings?.statistics?.mapping_rate || 0) + '%'"></span>
                                </div>
                                <div class="h-2 bg-slate-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-green-500 to-primary-500 transition-all duration-500"
                                         :style="'width: ' + (ruleMappings?.statistics?.mapping_rate || 0) + '%'"></div>
                                </div>
                            </div>

                            <!-- Filters -->
                            <div class="flex flex-wrap items-center gap-2">
                                <div class="flex items-center gap-1 bg-slate-100 rounded-lg p-1">
                                    <button @click="mappingFilterStatus = 'all'" class="px-3 py-1.5 text-xs rounded-md transition-all" :class="mappingFilterStatus === 'all' ? 'bg-white shadow text-slate-800' : 'text-slate-500 hover:text-slate-700'">전체</button>
                                    <button @click="mappingFilterStatus = 'mapped'" class="px-3 py-1.5 text-xs rounded-md transition-all" :class="mappingFilterStatus === 'mapped' ? 'bg-white shadow text-green-600' : 'text-slate-500 hover:text-slate-700'">매핑완료</button>
                                    <button @click="mappingFilterStatus = 'partial'" class="px-3 py-1.5 text-xs rounded-md transition-all" :class="mappingFilterStatus === 'partial' ? 'bg-white shadow text-amber-600' : 'text-slate-500 hover:text-slate-700'">부분</button>
                                    <button @click="mappingFilterStatus = 'unmapped'" class="px-3 py-1.5 text-xs rounded-md transition-all" :class="mappingFilterStatus === 'unmapped' ? 'bg-white shadow text-red-600' : 'text-slate-500 hover:text-slate-700'">미매핑</button>
                                </div>
                                <select x-model="selectedMappingSheet" class="px-3 py-1.5 text-xs border border-slate-300 rounded-lg bg-white">
                                    <option value="all">모든 시트</option>
                                    <template x-for="sheet in ruleMappings?.sheets || []" :key="sheet.sheet_name">
                                        <option :value="sheet.sheet_name" x-text="sheet.sheet_name + ' (' + sheet.rules.length + ')'"></option>
                                    </template>
                                </select>
                            </div>
                        </div>

                        <!-- Loading -->
                        <div x-show="ruleMappingsLoading" class="bg-white rounded-xl border border-slate-200 shadow-sm p-12 text-center">
                            <i class="ph ph-circle-notch text-4xl text-primary-600 animate-spin mb-3"></i>
                            <p class="text-slate-600">매핑 정보를 불러오는 중...</p>
                        </div>

                        <!-- Mapping Table -->
                        <div x-show="!ruleMappingsLoading && ruleMappings" class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm">
                                    <thead class="bg-slate-50 border-b border-slate-200">
                                        <tr>
                                            <th class="text-left px-4 py-3 font-medium text-slate-600">상태</th>
                                            <th class="text-center px-4 py-3 font-medium text-slate-600">공통</th>
                                            <th class="text-left px-4 py-3 font-medium text-slate-600">시트</th>
                                            <th class="text-left px-4 py-3 font-medium text-slate-600">필드명</th>
                                            <th class="text-left px-4 py-3 font-medium text-slate-600 min-w-[200px]">원본 규칙</th>
                                            <th class="text-left px-4 py-3 font-medium text-slate-600">AI 해석 유형</th>
                                            <th class="text-left px-4 py-3 font-medium text-slate-600">파라미터</th>
                                            <th class="text-left px-4 py-3 font-medium text-slate-600">신뢰도</th>
                                            <th class="text-left px-4 py-3 font-medium text-slate-600">작업</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100">
                                        <template x-for="sheet in getFilteredMappingSheets()" :key="sheet.sheet_name">
                                            <template x-for="rule in getFilteredRules(sheet.rules)" :key="rule.id">
                                                <tr class="hover:bg-slate-50 transition-colors">
                                                    <td class="px-4 py-3">
                                                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium"
                                                              :class="rule.mapping_status === 'mapped' ? 'bg-green-100 text-green-700' :
                                                                      rule.mapping_status === 'partial' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'">
                                                            <i :class="rule.mapping_status === 'mapped' ? 'ph-fill ph-check-circle' :
                                                                       rule.mapping_status === 'partial' ? 'ph-fill ph-warning' : 'ph-fill ph-x-circle'"></i>
                                                            <span x-text="rule.mapping_status === 'mapped' ? '완료' : rule.mapping_status === 'partial' ? '부분' : '미매핑'"></span>
                                                        </span>
                                                    </td>
                                                    <td class="px-4 py-3 text-center">
                                                        <span x-show="rule.is_common" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-purple-100 text-purple-600" title="공통 규칙">
                                                            <i class="ph-fill ph-check-circle text-lg"></i>
                                                        </span>
                                                        <span x-show="!rule.is_common" class="text-slate-200">
                                                            <i class="ph ph-minus text-lg"></i>
                                                        </span>
                                                    </td>
                                                    <td class="px-4 py-3">
                                                        <span class="text-xs bg-slate-100 px-2 py-1 rounded" x-text="rule.sheet_name"></span>
                                                    </td>
                                                    <td class="px-4 py-3 font-medium text-slate-800" x-text="rule.field_name"></td>
                                                    <td class="px-4 py-3 text-slate-600 max-w-[250px]">
                                                        <div class="truncate" x-text="rule.rule_text" :title="rule.rule_text"></div>
                                                    </td>
                                                    <td class="px-4 py-3">
                                                        <span x-show="rule.ai_rule_type" class="text-xs bg-primary-100 text-primary-700 px-2 py-1 rounded" x-text="rule.ai_rule_type"></span>
                                                        <span x-show="!rule.ai_rule_type" class="text-xs text-slate-400">-</span>
                                                    </td>
                                                    <td class="px-4 py-3 text-xs text-slate-500 max-w-[150px]">
                                                        <div class="truncate" x-text="rule.ai_parameters ? JSON.stringify(rule.ai_parameters) : '-'" :title="rule.ai_parameters ? JSON.stringify(rule.ai_parameters) : ''"></div>
                                                    </td>
                                                    <td class="px-4 py-3">
                                                        <div x-show="rule.ai_confidence_score" class="flex items-center gap-1">
                                                            <div class="w-12 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                                                                <div class="h-full rounded-full transition-all"
                                                                     :class="rule.ai_confidence_score >= 0.8 ? 'bg-green-500' : rule.ai_confidence_score >= 0.5 ? 'bg-amber-500' : 'bg-red-500'"
                                                                     :style="'width: ' + (rule.ai_confidence_score * 100) + '%'"></div>
                                                            </div>
                                                            <span class="text-xs" x-text="Math.round(rule.ai_confidence_score * 100) + '%'"></span>
                                                        </div>
                                                        <span x-show="!rule.ai_confidence_score" class="text-xs text-slate-400">-</span>
                                                    </td>
                                                    <td class="px-4 py-3">
                                                        <div class="flex items-center gap-1">
                                                            <button @click="openMappingEditor(rule)" class="p-1.5 text-slate-500 hover:text-primary-600 hover:bg-primary-50 rounded transition-colors" title="편집">
                                                                <i class="ph ph-pencil-simple"></i>
                                                            </button>
                                                            <button @click="deleteRule(rule.id)" class="p-1.5 text-slate-500 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="삭제">
                                                                <i class="ph ph-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            <div x-show="getFilteredMappingSheets().length === 0" class="p-8 text-center text-slate-400">
                                <i class="ph ph-funnel text-3xl mb-2"></i>
                                <p>필터 조건에 맞는 규칙이 없습니다</p>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="flex justify-between">
                            <button @click="ruleManagementStep = 1" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors flex items-center gap-2">
                                <i class="ph ph-arrow-left"></i>
                                <span>파일 선택으로</span>
                            </button>
                            <button @click="downloadRuleFile(selectedRuleFile, ruleMappings?.file_name)" class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center gap-2">
                                <i class="ph ph-download-simple"></i>
                                <span>규칙 파일 다운로드</span>
                            </button>
                        </div>
                    </div>

                </div>

                <!-- Rule Edit Modal -->
                <template x-if="editingRule">
                <div x-show="editingRule" x-cloak class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4" @click.self="cancelEditingRule">
                    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto" @click.stop>
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                                <i class="ph-fill ph-note-pencil text-primary-600"></i>
                                규칙 편집
                            </h3>
                            <button @click="cancelEditingRule" class="text-slate-400 hover:text-slate-600">
                                <i class="ph ph-x text-xl"></i>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <!-- Basic Info (Read only) -->
                            <div class="grid grid-cols-2 gap-4 text-xs">
                                <div class="bg-slate-50 p-2 rounded">
                                    <span class="text-slate-500 block mb-1">시트명</span>
                                    <span class="font-medium" x-text="editingRule?.display_sheet_name"></span>
                                </div>
                                <div class="bg-slate-50 p-2 rounded">
                                    <span class="text-slate-500 block mb-1">위치</span>
                                    <span class="font-medium" x-text="editingRule?.row_number + '행 ' + editingRule?.column_letter + '열'"></span>
                                </div>
                            </div>

                            <!-- Editable Fields -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">필드명</label>
                                <input type="text" x-model="editingRule.field_name" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">규칙 원본 (자연어)</label>
                                <textarea x-model="editingRule.rule_text" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 h-20"></textarea>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">조건</label>
                                    <input type="text" x-model="editingRule.condition" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">비고</label>
                                    <input type="text" x-model="editingRule.note" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">
                                </div>
                            </div>

                            <!-- AI Interpretation (Manually adjustable) -->
                            <div class="p-4 border border-blue-100 bg-blue-50/30 rounded-lg space-y-3">
                                <div class="flex items-center gap-2 text-blue-700 text-sm font-bold mb-1">
                                    <i class="ph-fill ph-magic-wand"></i>
                                    AI 해석 정보
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">해석 유형</label>
                                        <select x-model="editingRule.ai_rule_type" class="w-full px-2 py-1.5 text-sm border border-slate-300 rounded bg-white">
                                            <option value="required">필수 입력 (required)</option>
                                            <option value="format">형식 검증 (format)</option>
                                            <option value="range">범위 검증 (range)</option>
                                            <option value="no_duplicates">중복 제거 (no_duplicates)</option>
                                            <option value="date_logic">날짜 로직 (date_logic)</option>
                                            <option value="cross_field">교차 필드 (cross_field)</option>
                                            <option value="custom">사용자 정의 (custom)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 mb-1">신뢰도</label>
                                        <div class="flex items-center gap-2">
                                            <input type="range" min="0" max="1" step="0.1" x-model="editingRule.ai_confidence_score" class="flex-1">
                                            <span class="text-xs font-mono" x-text="editingRule.ai_confidence_score"></span>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">해석 파라미터 (JSON)</label>
                                    <textarea x-model="editingRuleParamsJson" class="w-full px-2 py-1.5 text-xs font-mono border border-slate-300 rounded bg-white h-20"
                                              :class="paramsValid ? 'border-slate-300' : 'border-red-500 shadow-[0_0_0_1px_rgba(239,68,68,1)]'"
                                              @input="validateParamsJson()"></textarea>
                                    <p x-show="!paramsValid" class="text-[10px] text-red-500 mt-1">올바른 JSON 형식이 아닙니다.</p>
                                </div>
                            </div>

                            <!-- Status -->
                            <div class="flex items-center gap-3 py-2">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" x-model="editingRule.is_active" class="sr-only peer">
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                    <span class="ml-3 text-sm font-medium text-slate-700" x-text="editingRule.is_active ? '활성화됨' : '비활성'"></span>
                                </label>
                            </div>

                            <!-- Actions -->
                            <div class="flex gap-3 justify-end pt-4 border-t border-slate-100">
                                <button @click="deleteRule(editingRule.id)" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors mr-auto flex items-center gap-1">
                                    <i class="ph ph-trash"></i>
                                    <span>삭제</span>
                                </button>
                                <button @click="cancelEditingRule" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">취소</button>
                                <button @click="saveRule" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-bold shadow-lg shadow-primary-200"
                                        :disabled="!paramsValid">
                                    저장하기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                </template>

                <!-- Mapping Editor Modal (NEW) -->
                <div x-show="editingMapping" x-cloak class="fixed inset-0 bg-black/50 z-[62] flex items-center justify-center p-4" @click.self="editingMapping = null">
                    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto" @click.stop>
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                                <i class="ph-fill ph-link text-primary-600"></i>
                                규칙 매핑 편집
                            </h3>
                            <button @click="editingMapping = null" class="text-slate-400 hover:text-slate-600">
                                <i class="ph ph-x text-xl"></i>
                            </button>
                        </div>

                        <template x-if="editingMapping">
                            <div class="space-y-4">
                                <!-- Original Rule Info (Editable) -->
                                <div class="bg-slate-50 rounded-lg p-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="text-sm font-medium text-slate-700 flex items-center gap-2">
                                            <i class="ph ph-file-text text-slate-500"></i>
                                            원본 규칙 정보
                                        </div>
                                        <button @click="reinterpretSingleRule()"
                                                :disabled="reinterpretingRule"
                                                class="px-3 py-1.5 text-xs bg-amber-100 hover:bg-amber-200 text-amber-700 rounded-lg transition-colors flex items-center gap-1 disabled:opacity-50 disabled:cursor-not-allowed"
                                                title="원본 규칙을 기반으로 AI가 다시 해석합니다">
                                            <i class="ph ph-arrows-clockwise" :class="reinterpretingRule && 'animate-spin'"></i>
                                            <span x-text="reinterpretingRule ? '재해석 중...' : '이 규칙 재해석'"></span>
                                        </button>
                                    </div>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="text-xs text-slate-500 mb-1 block">시트명</label>
                                                <select x-model="editingMapping.sheet_name" class="w-full px-2 py-1.5 text-sm border border-slate-300 rounded bg-white focus:ring-2 focus:ring-primary-500">
                                                    <template x-for="sheet in ruleMappings?.sheets || []" :key="sheet.sheet_name">
                                                        <option :value="sheet.sheet_name" x-text="sheet.sheet_name"></option>
                                                    </template>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="text-xs text-slate-500 mb-1 block">위치 (행/열)</label>
                                                <div class="flex items-center gap-1">
                                                    <input type="number" x-model="editingMapping.row_number" class="w-16 px-2 py-1.5 text-sm border border-slate-300 rounded focus:ring-2 focus:ring-primary-500" placeholder="행">
                                                    <span class="text-slate-400 text-sm">행</span>
                                                    <input type="text" x-model="editingMapping.column_letter" class="w-12 px-2 py-1.5 text-sm border border-slate-300 rounded focus:ring-2 focus:ring-primary-500 uppercase" placeholder="열" maxlength="2">
                                                    <span class="text-slate-400 text-sm">열</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <div class="flex-1">
                                                <label class="text-xs text-slate-500 mb-1 block">필드명</label>
                                                <input type="text" x-model="editingMapping.field_name" class="w-full px-2 py-1.5 text-sm border border-slate-300 rounded focus:ring-2 focus:ring-primary-500" placeholder="예: 성명">
                                            </div>
                                            <div class="flex items-center pt-5">
                                                <label class="flex items-center gap-2 cursor-pointer">
                                                    <input type="checkbox" x-model="editingMapping.is_common" class="w-4 h-4 text-primary-600 rounded border-slate-300 focus:ring-primary-500">
                                                    <span class="text-sm text-slate-700 font-medium">공통 규칙 적용</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="text-xs text-slate-500 mb-1 block">규칙 원문 (자연어)</label>
                                            <textarea x-model="editingMapping.rule_text" class="w-full px-2 py-1.5 text-sm border border-slate-300 rounded focus:ring-2 focus:ring-primary-500 h-20" placeholder="예: 필수 입력, YYYYMMDD 형식"></textarea>
                                            <p class="text-xs text-slate-400 mt-1">규칙 원문을 수정한 후 "이 규칙 재해석"을 클릭하면 AI가 새로운 해석을 생성합니다</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- AI Interpretation Settings -->
                                <div class="border border-primary-200 bg-primary-50/30 rounded-lg p-4">
                                    <div class="flex items-center gap-2 text-primary-700 font-bold mb-4">
                                        <i class="ph-fill ph-magic-wand"></i>
                                        AI 해석 설정 (검증에 사용됨)
                                    </div>

                                    <div class="space-y-4">
                                        <!-- Rule Type Selection -->
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-2">검증 유형 <span class="text-red-500">*</span></label>
                                            <select x-model="editingMapping.ai_rule_type" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-primary-500">
                                                <option value="">선택하세요...</option>
                                                <template x-for="type in ruleMappings?.available_rule_types || []" :key="type.value">
                                                    <option :value="type.value" x-text="type.label"></option>
                                                </template>
                                            </select>
                                            <p class="text-xs text-slate-500 mt-1" x-show="editingMapping.ai_rule_type"
                                               x-text="ruleMappings?.available_rule_types?.find(t => t.value === editingMapping.ai_rule_type)?.description"></p>
                                        </div>

                                        <!-- Parameters based on type -->
                                        <div x-show="editingMapping.ai_rule_type">
                                            <label class="block text-sm font-medium text-slate-700 mb-2">파라미터 설정</label>

                                            <!-- Required: no params needed -->
                                            <div x-show="editingMapping.ai_rule_type === 'required'" class="text-sm text-slate-500 bg-slate-50 p-3 rounded">
                                                필수 입력 검증은 추가 파라미터가 필요하지 않습니다.
                                            </div>

                                            <!-- No Duplicates: no params needed -->
                                            <div x-show="editingMapping.ai_rule_type === 'no_duplicates'" class="text-sm text-slate-500 bg-slate-50 p-3 rounded">
                                                중복 검증은 추가 파라미터가 필요하지 않습니다.
                                            </div>

                                            <!-- Format: regex or allowed_values -->
                                            <div x-show="editingMapping.ai_rule_type === 'format'" class="space-y-3">
                                                <div>
                                                    <label class="text-xs text-slate-600">형식 유형</label>
                                                    <select x-model="editingMapping._formatType" @change="updateFormatParams()" class="w-full mt-1 px-2 py-1.5 text-sm border border-slate-300 rounded bg-white">
                                                        <option value="date">날짜 형식 (YYYYMMDD)</option>
                                                        <option value="allowed">허용값 목록</option>
                                                        <option value="regex">정규식 패턴</option>
                                                    </select>
                                                </div>
                                                <div x-show="editingMapping._formatType === 'date'">
                                                    <label class="text-xs text-slate-600">날짜 형식</label>
                                                    <select x-model="editingMapping._dateFormat" @change="updateFormatParams()" class="w-full mt-1 px-2 py-1.5 text-sm border border-slate-300 rounded bg-white">
                                                        <option value="YYYYMMDD">YYYYMMDD (예: 20250101)</option>
                                                        <option value="YYYY-MM-DD">YYYY-MM-DD (예: 2025-01-01)</option>
                                                    </select>
                                                </div>
                                                <div x-show="editingMapping._formatType === 'allowed'">
                                                    <label class="text-xs text-slate-600">허용값 (쉼표로 구분)</label>
                                                    <input type="text" x-model="editingMapping._allowedValues" @input="updateFormatParams()"
                                                           class="w-full mt-1 px-2 py-1.5 text-sm border border-slate-300 rounded" placeholder="예: M, F 또는 1, 2">
                                                </div>
                                                <div x-show="editingMapping._formatType === 'regex'">
                                                    <label class="text-xs text-slate-600">정규식 패턴</label>
                                                    <input type="text" x-model="editingMapping._regexPattern" @input="updateFormatParams()"
                                                           class="w-full mt-1 px-2 py-1.5 text-sm border border-slate-300 rounded font-mono" placeholder="예: ^[0-9]{8}$">
                                                </div>
                                            </div>

                                            <!-- Range: min/max -->
                                            <div x-show="editingMapping.ai_rule_type === 'range'" class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label class="text-xs text-slate-600">최소값</label>
                                                    <input type="number" x-model="editingMapping._minValue" @input="updateRangeParams()"
                                                           class="w-full mt-1 px-2 py-1.5 text-sm border border-slate-300 rounded" placeholder="예: 0">
                                                </div>
                                                <div>
                                                    <label class="text-xs text-slate-600">최대값</label>
                                                    <input type="number" x-model="editingMapping._maxValue" @input="updateRangeParams()"
                                                           class="w-full mt-1 px-2 py-1.5 text-sm border border-slate-300 rounded" placeholder="예: 100">
                                                </div>
                                            </div>

                                            <!-- Date Logic -->
                                            <div x-show="editingMapping.ai_rule_type === 'date_logic'" class="space-y-3">
                                                <div>
                                                    <label class="text-xs text-slate-600">비교 필드</label>
                                                    <input type="text" x-model="editingMapping._compareField" @input="updateDateLogicParams()"
                                                           class="w-full mt-1 px-2 py-1.5 text-sm border border-slate-300 rounded" placeholder="예: 생년월일">
                                                </div>
                                                <div>
                                                    <label class="text-xs text-slate-600">비교 연산자</label>
                                                    <select x-model="editingMapping._dateOperator" @change="updateDateLogicParams()" class="w-full mt-1 px-2 py-1.5 text-sm border border-slate-300 rounded bg-white">
                                                        <option value="greater_than">이후 (>)</option>
                                                        <option value="less_than">이전 (<)</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- Custom: raw JSON -->
                                            <div x-show="editingMapping.ai_rule_type === 'custom' || editingMapping.ai_rule_type === 'cross_field'">
                                                <label class="text-xs text-slate-600">파라미터 (JSON)</label>
                                                <textarea x-model="editingMapping._rawParams" @input="updateCustomParams()"
                                                          class="w-full mt-1 px-2 py-1.5 text-sm font-mono border border-slate-300 rounded h-20" placeholder='{"key": "value"}'></textarea>
                                            </div>

                                            <!-- Composite: Multiple validations -->
                                            <div x-show="editingMapping.ai_rule_type === 'composite'" class="space-y-3">
                                                <div class="flex items-center justify-between">
                                                    <span class="text-xs text-slate-600">복합 검증 조건</span>
                                                    <button @click="addCompositeValidation()" type="button"
                                                            class="px-2 py-1 text-xs bg-green-100 text-green-700 hover:bg-green-200 rounded transition-colors flex items-center gap-1">
                                                        <i class="ph ph-plus"></i> 조건 추가
                                                    </button>
                                                </div>

                                                <!-- Validation List -->
                                                <div class="space-y-2 max-h-60 overflow-y-auto">
                                                    <template x-for="(v, vIdx) in editingMapping._validations || []" :key="vIdx">
                                                        <div class="border border-slate-200 rounded-lg p-3 bg-white">
                                                            <div class="flex items-center justify-between mb-2">
                                                                <span class="text-xs font-medium text-slate-700" x-text="'검증 #' + (vIdx + 1)"></span>
                                                                <button @click="removeCompositeValidation(vIdx)" type="button"
                                                                        class="p-1 text-red-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors">
                                                                    <i class="ph ph-x text-sm"></i>
                                                                </button>
                                                            </div>
                                                            <div class="grid grid-cols-2 gap-2">
                                                                <div>
                                                                    <select x-model="v.type" @change="updateCompositeParams()"
                                                                            class="w-full px-2 py-1 text-xs border border-slate-300 rounded bg-white">
                                                                        <option value="required">필수 입력</option>
                                                                        <option value="format">형식 검증</option>
                                                                        <option value="range">범위 검증</option>
                                                                        <option value="no_duplicates">중복 불가</option>
                                                                    </select>
                                                                </div>
                                                                <div x-show="v.type === 'format'">
                                                                    <input type="text" x-model="v._formatValue" @input="updateCompositeParams()"
                                                                           class="w-full px-2 py-1 text-xs border border-slate-300 rounded"
                                                                           placeholder="YYYYMMDD 또는 M,F">
                                                                </div>
                                                                <div x-show="v.type === 'range'" class="col-span-2 grid grid-cols-2 gap-1">
                                                                    <input type="number" x-model="v._minVal" @input="updateCompositeParams()"
                                                                           class="w-full px-2 py-1 text-xs border border-slate-300 rounded" placeholder="최소">
                                                                    <input type="number" x-model="v._maxVal" @input="updateCompositeParams()"
                                                                           class="w-full px-2 py-1 text-xs border border-slate-300 rounded" placeholder="최대">
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>

                                                <p x-show="!editingMapping._validations?.length" class="text-xs text-slate-400 text-center py-4">
                                                    "조건 추가" 버튼을 클릭하여 검증 조건을 추가하세요
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Error Message -->
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-2">오류 메시지</label>
                                            <input type="text" x-model="editingMapping.ai_error_message"
                                                   class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary-500"
                                                   placeholder="검증 실패 시 표시될 메시지">
                                            <p class="text-xs text-slate-500 mt-1">{field_name} 플레이스홀더를 사용하면 필드명으로 치환됩니다</p>
                                        </div>

                                        <!-- Confidence -->
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-2">신뢰도</label>
                                            <div class="flex items-center gap-3">
                                                <input type="range" min="0" max="1" step="0.1" x-model="editingMapping.ai_confidence_score" class="flex-1">
                                                <span class="text-sm font-mono w-12 text-right" x-text="(editingMapping.ai_confidence_score || 0).toFixed(1)"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="flex gap-3 justify-end pt-4 border-t border-slate-100">
                                    <button @click="editingMapping = null" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">취소</button>
                                    <button @click="saveMappingEdit()" :disabled="!editingMapping.ai_rule_type"
                                            class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-bold shadow-lg shadow-primary-200 disabled:bg-slate-300 disabled:shadow-none disabled:cursor-not-allowed">
                                        저장하기
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Create Rule Modal -->
                <div x-show="createRuleModalOpen" x-cloak class="fixed inset-0 bg-black/50 z-[65] flex items-center justify-center p-4" @click.self="createRuleModalOpen = false">
                    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6" @click.stop>
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-slate-900 flex items-center gap-2">
                                <i class="ph-fill ph-plus-circle text-green-600"></i>
                                새 규칙 추가
                            </h3>
                            <button @click="createRuleModalOpen = false" class="text-slate-400 hover:text-slate-600">
                                <i class="ph ph-x text-xl"></i>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">시트명 <span class="text-red-500">*</span></label>
                                    <select x-model="newRule.sheet_name"
                                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white">
                                        <option value="">시트 선택...</option>
                                        <template x-for="sheet in ruleFileDetails?.sheets" :key="sheet.sheet_name">
                                            <option :value="sheet.sheet_name" x-text="sheet.sheet_name"></option>
                                        </template>
                                        <option value="__new__">+ 새 시트 추가</option>
                                    </select>
                                    <input x-show="newRule.sheet_name === '__new__'"
                                           type="text"
                                           x-model="newRule.custom_sheet_name"
                                           class="w-full mt-2 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                           placeholder="새 시트명 입력">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">컬럼명 (필드명) <span class="text-red-500">*</span></label>
                                    <input type="text" x-model="newRule.column_name" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="예: 성명">
                                </div>
                            </div>

                            <div class="flex items-center">
                                <label class="flex items-center gap-2 cursor-pointer p-2 rounded hover:bg-slate-50 transition-colors w-full">
                                    <input type="checkbox" x-model="newRule.is_common" class="w-4 h-4 text-green-600 rounded border-slate-300 focus:ring-green-500">
                                    <div>
                                        <span class="text-sm font-medium text-slate-800">공통 규칙으로 설정</span>
                                        <p class="text-xs text-slate-500">체크 시 시트명과 관계없이 동일한 컬럼명을 가진 모든 시트에 적용됩니다.</p>
                                    </div>
                                </label>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">규칙 설명 (자연어)</label>
                                <textarea x-model="newRule.rule_text" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 h-24" placeholder="예: 이름은 필수이며 공백이 없어야 함"></textarea>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">조건 (선택사항)</label>
                                <input type="text" x-model="newRule.condition" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Excel 수식 등">
                            </div>

                            <div class="p-4 border border-green-100 bg-green-50/30 rounded-lg space-y-3">
                                <div class="flex items-center gap-2 text-green-700 text-sm font-bold mb-1">
                                    <i class="ph-fill ph-magic-wand"></i>
                                    AI 검증 설정
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">검증 유형</label>
                                    <select x-model="newRule.ai_rule_type" class="w-full px-2 py-1.5 text-sm border border-slate-300 rounded bg-white">
                                        <option value="required">필수 입력 (required)</option>
                                        <option value="format">형식 검증 (format)</option>
                                        <option value="range">범위 검증 (range)</option>
                                        <option value="no_duplicates">중복 제거 (no_duplicates)</option>
                                        <option value="date_logic">날짜 로직 (date_logic)</option>
                                        <option value="cross_field">교차 필드 (cross_field)</option>
                                        <option value="custom">사용자 정의 / 기타 (custom)</option>
                                    </select>
                                    <p class="text-[10px] text-slate-400 mt-1">
                                        * '사용자 정의' 선택 시 AI가 자연어를 해석하여 처리합니다.
                                    </p>
                                </div>
                            </div>

                            <div class="flex gap-3 justify-end pt-4 border-t border-slate-100">
                                <button @click="createRuleModalOpen = false" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">취소</button>
                                <button @click="createRule" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-bold shadow-lg shadow-green-200"
                                        :disabled="(!newRule.sheet_name || (newRule.sheet_name === '__new__' && !newRule.custom_sheet_name)) || !newRule.column_name || !newRule.rule_text">
                                    추가하기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: AI FIX -->
            <div x-show="currentTab === 'ai_fix'" x-cloak>
                <div class="max-w-6xl mx-auto space-y-6">
                    
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900 flex items-center gap-2">
                                <i class="ph-fill ph-magic-wand text-indigo-500"></i>
                                AI 스마트 수정 어시스턴트
                            </h2>
                            <p class="text-slate-500 mt-1">AI가 분석한 수정 제안을 검토하고 일괄 적용하세요.</p>
                        </div>
                    </div>

                    <!-- Main Content Card -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col h-[calc(100vh-200px)]">
                        
                        <!-- Loading State -->
                        <div x-show="isFixLoading" class="flex-1 flex flex-col items-center justify-center space-y-4">
                            <div class="relative w-20 h-20">
                                <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                                <div class="absolute inset-0 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin"></div>
                                <i class="ph-fill ph-brain absolute inset-0 m-auto text-2xl text-indigo-500 flex items-center justify-center animate-pulse"></i>
                            </div>
                            <div class="text-center">
                                <h4 class="text-lg font-semibold text-slate-800">AI가 오류를 분석 중입니다...</h4>
                                <p class="text-sm text-slate-500">과거 수정 패턴과 규칙을 대조하고 있습니다.</p>
                            </div>
                        </div>

                        <!-- Empty/Initial State -->
                        <div x-show="!isFixLoading && fixSuggestions.length === 0" class="flex-1 flex flex-col items-center justify-center space-y-4">
                            <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center text-slate-300">
                                <i class="ph-fill ph-magic-wand text-4xl"></i>
                            </div>
                            <div class="text-center">
                                <h4 class="text-lg font-semibold text-slate-800">수정 제안이 없습니다</h4>
                                <p class="text-sm text-slate-500 mb-4">분석된 오류가 없거나 AI가 수정 가능한 항목을 찾지 못했습니다.</p>
                                <button @click="openSmartFixTab" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors shadow-sm text-sm flex items-center gap-2 mx-auto">
                                    <i class="ph-bold ph-arrows-clockwise"></i>
                                    <span>다시 분석하기</span>
                                </button>
                            </div>
                        </div>

                        <!-- Content State -->
                        <div x-show="!isFixLoading && fixSuggestions.length > 0" class="flex-1 flex flex-col overflow-hidden">
                            <!-- Toolbar -->
                            <div class="px-6 py-3 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <label class="flex items-center gap-2 text-sm font-medium text-slate-700 cursor-pointer">
                                        <input type="checkbox" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500" 
                                               :checked="selectedFixes.length === fixSuggestions.length && fixSuggestions.length > 0"
                                               @change="toggleAllFixes">
                                        전체 선택 (<span x-text="selectedFixes.length"></span>)
                                    </label>
                                    <div class="h-4 w-px bg-slate-300"></div>
                                    <div class="flex gap-2">
                                        <button @click="filterConfidence(0.9)" class="text-xs px-2 py-1 rounded bg-white border border-slate-200 hover:border-indigo-300 hover:text-indigo-600 transition-colors">
                                            신뢰도 90% 이상만
                                        </button>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-500">
                                    총 <span class="font-bold text-slate-800" x-text="fixSuggestions.length"></span>건의 제안
                                </div>
                            </div>

                            <!-- Table -->
                            <div class="flex-1 overflow-y-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-white text-slate-500 font-medium sticky top-0 z-10 shadow-sm">
                                        <tr>
                                            <th class="px-6 py-3 w-12"></th>
                                            <th class="px-6 py-3">위치</th>
                                            <th class="px-6 py-3">현재 값 (오류)</th>
                                            <th class="px-6 py-3">
                                                <div class="flex items-center gap-1">
                                                    수정 제안
                                                    <i class="ph-fill ph-arrow-right text-indigo-500"></i>
                                                </div>
                                            </th>
                                            <th class="px-6 py-3">근거 / 신뢰도</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-100 bg-white">
                                        <template x-for="(fix, index) in fixSuggestions" :key="index">
                                            <tr class="hover:bg-indigo-50/30 transition-colors" :class="{'bg-indigo-50/50': selectedFixes.includes(index)}">
                                                <td class="px-6 py-4">
                                                    <input type="checkbox" :value="index" x-model="selectedFixes" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer">
                                                </td>
                                                <td class="px-6 py-4">
                                                    <div class="font-medium text-slate-900" x-text="fix.sheet_name"></div>
                                                    <div class="text-xs text-slate-500 font-mono" x-text="fix.column + ' (Row ' + fix.row + ')'"></div>
                                                </td>
                                                <td class="px-6 py-4">
                                                    <span class="px-2 py-1 bg-red-50 text-red-600 rounded text-xs font-mono line-through decoration-red-300" x-text="fix.original_value"></span>
                                                </td>
                                                <td class="px-6 py-4">
                                                    <input type="text" x-model="fix.fixed_value" 
                                                           class="w-full px-2 py-1 text-sm border-b-2 border-slate-200 focus:border-indigo-500 focus:outline-none bg-transparent font-medium text-indigo-700 font-mono">
                                                </td>
                                                <td class="px-6 py-4">
                                                    <div class="space-y-1">
                                                        <div class="text-xs text-slate-600" x-text="fix.reason"></div>
                                                        <div class="flex items-center gap-2">
                                                            <div class="h-1.5 w-16 bg-slate-100 rounded-full overflow-hidden">
                                                                <div class="h-full rounded-full" 
                                                                     :class="getConfidenceColor(fix.confidence_score)"
                                                                     :style="'width: ' + (fix.confidence_score * 100) + '%'"></div>
                                                            </div>
                                                            <span class="text-[10px] font-bold" x-text="Math.round(fix.confidence_score * 100) + '%'"></span>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Footer -->
                            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
                                <span class="text-sm text-slate-500">
                                    <i class="ph-fill ph-check-circle text-indigo-500"></i>
                                    <span class="font-bold text-slate-800" x-text="selectedFixes.length"></span>건 선택됨
                                </span>
                                <div class="flex gap-3">
                                    <button @click="applySmartFixes" 
                                            class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-bold shadow-md shadow-indigo-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                                            :disabled="selectedFixes.length === 0">
                                        <i class="ph-bold ph-download-simple"></i>
                                        적용하여 다운로드
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: RULE FILE DETAILS -->
            <div x-show="currentTab === 'rule_detail'" x-cloak>
                <!-- Loading State -->
                <div x-show="!ruleFileDetails" class="flex flex-col items-center justify-center h-96">
                    <i class="ph-bold ph-spinner animate-spin text-4xl text-primary-500 mb-4"></i>
                    <p class="text-slate-500">규칙 상세 정보를 불러오는 중입니다...</p>
                </div>

                <!-- Content -->
                <div class="max-w-6xl mx-auto space-y-6" x-show="ruleFileDetails">
                    
                    <!-- Header -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <button @click="closeRuleFileDetails" class="p-2 text-slate-400 hover:text-slate-600 rounded-lg hover:bg-slate-100 transition-colors">
                                <i class="ph ph-arrow-left text-xl"></i>
                            </button>
                            <div>
                                <h2 class="text-2xl font-bold text-slate-900" x-text="ruleFileDetails?.file_name"></h2>
                                <div class="flex items-center gap-2 text-sm text-slate-500">
                                    <i class="ph ph-file-text"></i>
                                    <span x-text="'ID: ' + ruleFileDetails?.id"></span>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button @click="openCreateRuleModal" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2 shadow-sm font-medium">
                                <i class="ph ph-plus-circle text-lg"></i>
                                <span>규칙 추가</span>
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm">
                            <div class="text-sm text-slate-500 mb-1">버전</div>
                            <div class="text-2xl font-bold text-slate-800" x-text="'v' + ruleFileDetails?.file_version"></div>
                        </div>
                        <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm">
                            <div class="text-sm text-slate-500 mb-1">총 규칙 수</div>
                            <div class="text-2xl font-bold text-slate-800" x-text="ruleFileDetails?.total_rules_count"></div>
                        </div>
                        <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm">
                            <div class="text-sm text-slate-500 mb-1">시트 수</div>
                            <div class="text-2xl font-bold text-slate-800" x-text="ruleFileDetails?.sheet_count"></div>
                        </div>
                        <div class="bg-white rounded-xl border border-slate-200 p-5 shadow-sm">
                            <div class="text-sm text-slate-500 mb-1">AI 해석률</div>
                            <div class="flex items-center justify-between">
                                <div class="text-2xl font-bold text-slate-800" x-text="Math.round((ruleFileDetails?.statistics?.interpretation_rate || 0) * 100) + '%'"></div>
                                <button x-show="(ruleFileDetails?.statistics?.interpretation_rate || 0) < 1"
                                        @click="interpretRules(ruleFileDetails.id)"
                                        class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded hover:bg-indigo-100 transition-colors flex items-center gap-1 border border-indigo-100">
                                    <i class="ph-fill ph-magic-wand"></i> 실행
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Rules Content -->
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div class="p-4 border-b border-slate-100 bg-slate-50/50">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                <i class="ph-fill ph-stack text-indigo-500"></i>
                                시트별 규칙 목록
                            </h3>
                        </div>
                        
                        <div class="divide-y divide-slate-100">
                            <template x-for="sheet in ruleFileDetails?.sheets" :key="sheet.sheet_name">
                                <div class="p-6">
                                    <div class="flex items-center justify-between mb-4">
                                        <h4 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                            <i class="ph ph-table text-slate-400"></i>
                                            <span x-text="sheet.sheet_name"></span>
                                        </h4>
                                        <span class="px-2.5 py-1 bg-slate-100 text-slate-600 text-xs font-medium rounded-full" x-text="sheet.rule_count + '개 규칙'"></span>
                                    </div>
                                    
                                    <div class="bg-slate-50 rounded-lg border border-slate-200 overflow-hidden">
                                        <template x-for="rule in sheet.sample_rules" :key="rule.id">
                                            <div class="group flex items-start gap-3 p-3 border-b border-slate-200 last:border-0 hover:bg-white transition-colors">
                                                <div class="mt-1">
                                                    <i class="ph-fill ph-check-circle text-green-500" x-show="rule.has_ai_interpretation"></i>
                                                    <i class="ph-fill ph-circle text-slate-300" x-show="!rule.has_ai_interpretation"></i>
                                                </div>
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-center gap-2 mb-0.5">
                                                        <span class="font-bold text-slate-700 text-sm" x-text="rule.field_name"></span>
                                                        <template x-if="rule.is_common">
                                                            <span class="px-1.5 py-0.5 bg-purple-100 text-purple-700 text-[10px] font-bold rounded border border-purple-200">공통</span>
                                                        </template>
                                                        <span class="text-xs text-slate-400 font-mono" x-text="'ID: ' + rule.id.substring(0,8)"></span>
                                                    </div>
                                                    <div class="text-sm text-slate-600" x-text="rule.rule_text"></div>
                                                </div>
                                                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
                                                    <button @click="startEditingRule(rule.id)"
                                                            class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg"
                                                            title="규칙 편집">
                                                        <i class="ph-fill ph-pencil-simple text-lg"></i>
                                                    </button>
                                                    <button @click="deleteRule(rule.id)"
                                                            class="p-2 text-red-500 hover:bg-red-50 rounded-lg"
                                                            title="규칙 삭제">
                                                        <i class="ph-fill ph-trash text-lg"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </template>
                                        <div x-show="sheet.rule_count > sheet.sample_rules.length" class="p-2 text-center text-xs text-slate-400 bg-slate-50">
                                            ... 외 <span x-text="sheet.rule_count - sheet.sample_rules.length"></span>개 규칙 더 있음
                                        </div>
                                        <div x-show="sheet.rule_count === 0" class="p-8 text-center text-slate-400">
                                            등록된 규칙이 없습니다.
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        function app() {
            return {
                sidebarOpen: false,
                currentTab: 'upload', // upload, dashboard, report
                
                // File Upload State
                fileA: null,
                fileB: null,
                dragOverA: false,
                dragOverB: false,
                isLoading: false,
                useSavedRule: true, // Default to using DB rules
                selectedSavedRuleId: null,

                // Results State
                results: null,
                dbErrors: null, // DB에서 가져온 에러들 (ID 포함)
                searchQuery: '',
                filterSheet: 'all',
                currentPage: 1,
                pageSize: 20,
                frontendVersion: 'Front: v1.4.1 (2025-01-13)',
                backendVersion: 'Back: Checking...',
                selectedSheet: null, // 현재 선택된 시트
                dashboardTab: 'analysis', // 'analysis' or 'fix'

                // Feedback State
                feedbackModalOpen: false,
                selectedError: null,
                feedbackReason: '',

                // Rules Management State
                ruleFiles: [],
                selectedRuleFile: null,
                ruleFileDetails: null,
                uploadingRuleFile: false,
                ruleFileToUpload: null,
                ruleFileVersion: '1.0',
                ruleFileUploadedBy: 'system',
                ruleFileNotes: '',

                // Settings State
                settingsModalOpen: false,
                aiProvider: 'openai', // Default

                // Rule Editor State
                editingRule: null,
                editingRuleParamsJson: '{}',
                paramsValid: true,

                // Rule Mapping State (NEW)
                ruleMappings: null,
                ruleMappingsLoading: false,
                selectedMappingSheet: 'all',
                mappingFilterStatus: 'all',  // 'all', 'mapped', 'unmapped', 'partial'
                editingMapping: null,
                reinterpretingRule: false,  // Single rule reinterpretation loading state
                ruleManagementStep: 1,  // 1: 파일 선택/업로드, 2: 규칙 매핑 편집

                // Create Rule State
                createRuleModalOpen: false,
                newRule: {
                    sheet_name: '',
                    custom_sheet_name: '',
                    column_name: '',
                    rule_text: '',
                    condition: '',
                    ai_rule_type: 'required'
                },

                async createRule() {
                    const fileId = this.ruleFileDetails?.id || this.selectedRuleFile;
                    if (!fileId) {
                        this.showToast('규칙을 추가할 상위 규칙 파일이 선택되지 않았습니다.', 'error');
                        return;
                    }

                    // Handle custom sheet name
                    const actualSheetName = this.newRule.sheet_name === '__new__'
                        ? this.newRule.custom_sheet_name
                        : this.newRule.sheet_name;

                    const payload = {
                        ...this.newRule,
                        sheet_name: actualSheetName,
                        rule_file_id: fileId,
                        row_number: this.newRule.row_number || 0,
                        ai_parameters: {}
                    };

                    try {
                        const response = await fetch('http://localhost:8000/rules/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.detail || '규칙 생성에 실패했습니다.');
                        }

                        this.showToast('새로운 규칙이 성공적으로 추가되었습니다.', 'success');
                        this.createRuleModalOpen = false;
                        this.newRule = { sheet_name: '', custom_sheet_name: '', column_name: '', rule_text: '', condition: '', ai_rule_type: 'required' };

                        // 데이터 다시 로드
                        this.viewRuleFileDetails(fileId);
                        this.loadRuleFiles();

                    } catch (e) {
                        this.showToast(e.message, 'error');
                    }
                },

                async deleteRule(ruleId) {
                    if (!ruleId) {
                        this.showToast('삭제할 규칙의 ID가 없습니다.', 'error');
                        return;
                    }

                    if (!confirm('정말로 이 규칙을 영구적으로 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.')) {
                        return;
                    }

                    try {
                        // Use permanent=true to actually delete it
                        const response = await fetch(`http://localhost:8000/rules/${ruleId}?permanent=true`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.detail || '규칙 삭제에 실패했습니다.');
                        }

                        this.showToast('규칙이 성공적으로 삭제되었습니다.', 'success');
                        
                        // --- UI Update Logic ---
                        
                        // 1. Update Rule File Details View
                        if (this.ruleFileDetails && this.ruleFileDetails.sheets) {
                            this.ruleFileDetails.sheets.forEach(sheet => {
                                const index = sheet.sample_rules.findIndex(r => r.id === ruleId);
                                if (index > -1) {
                                    sheet.sample_rules.splice(index, 1);
                                    sheet.rule_count--; 
                                }
                            });
                            if (this.ruleFileDetails.total_rules_count) {
                                this.ruleFileDetails.total_rules_count--;
                            }
                        }

                        // 2. Update Rule Mappings View (Mapping Editor)
                        if (this.ruleMappings && this.ruleMappings.sheets) {
                            this.ruleMappings.sheets.forEach(sheet => {
                                const index = sheet.rules.findIndex(r => r.id === ruleId);
                                if (index > -1) {
                                    // Update stats before removing
                                    const status = sheet.rules[index].mapping_status;
                                    if (status === 'mapped') this.ruleMappings.statistics.mapped_count--;
                                    else if (status === 'partial') this.ruleMappings.statistics.partial_count--;
                                    else this.ruleMappings.statistics.unmapped_count--;
                                    
                                    this.ruleMappings.statistics.total_rules--;
                                    
                                    // Remove rule
                                    sheet.rules.splice(index, 1);
                                }
                            });
                        }

                        this.editingRule = null; // Close edit modal if open

                    } catch (e) {
                        this.showToast(e.message, 'error');
                        console.error(e);
                    }
                },

                async archiveRuleFile(fileId) {
                    if (!confirm('이 규칙 파일을 삭제하시겠습니까?\n\n모든 규칙이 비활성화됩니다.')) {
                        return;
                    }
                    try {
                        const response = await fetch(`http://localhost:8000/rules/files/${fileId}`, {
                            method: 'DELETE'
                        });
                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.detail?.message || err.detail || '삭제 실패');
                        }

                        this.showToast('규칙 파일이 삭제되었습니다.', 'success');
                        this.loadRuleFiles();

                        // 상세 페이지가 열려있으면 닫기
                        if (this.ruleFileDetails?.id === fileId) {
                            this.closeRuleFileDetails();
                        }
                    } catch (e) {
                        this.showToast(e.message, 'error');
                    }
                },

                // Smart Fix State
                // fixModalOpen: false, // Removed in favor of tab
                isFixLoading: false,
                fixSuggestions: [],
                selectedFixes: [],

                // Bulk Fix State (오류 항목 일괄 수정)
                fixActiveTab: 'before',  // 'before' | 'after'
                fixFilterSheet: 'all',
                fixPreviewFilter: 'all',
                selectedFixItems: [],  // [key, key, ...] - 'sheet::column' 형태
                isDownloading: false,
                fixPreview: { total: 0, success: 0, fail: 0, successRate: 0, items: [] },

                // Navigation Groups
                navGroups: [
                    {
                        title: "검증 실행",
                        items: [
                            { id: 'rules', label: '규칙 관리', icon: 'ph-gear-six' },
                            { id: 'upload', label: '파일 업로드 (검증)', icon: 'ph-upload-simple' }
                        ]
                    },
                    {
                        title: "결과 분석 및 수정",
                        items: [
                            { id: 'dashboard', label: '검증 대시보드', icon: 'ph-chart-pie-slice' },
                            { id: 'report', label: '상세 리포트', icon: 'ph-table' },
                            { id: 'ai_fix', label: 'AI 스마트 수정', icon: 'ph-magic-wand' }
                        ]
                    },
                    {
                        title: "시스템 관리",
                        items: [
                            { id: 'learning', label: 'AI 학습 현황', icon: 'ph-brain' },
                            { id: 'statistics', label: '통계 분석', icon: 'ph-trend-up' },
                            { id: 'settings', label: '설정 (AI 모델)', icon: 'ph-gear' }
                        ]
                    }
                ],

                get navItems() {
                    return this.navGroups.flatMap(g => g.items);
                },

                // Toast State
                toasts: [],

                // AI Explanation Modal State
                aiExplanationModalOpen: false,
                isExplanationLoading: false,
                currentExplanation: { title: '', explanation: '', recommendation: '' },

                showToast(message, type = 'info') {
                    const id = Date.now();
                    const titleMap = {
                        'success': '성공',
                        'error': '오류',
                        'info': '알림'
                    };
                    
                    this.toasts.push({
                        id,
                        title: titleMap[type],
                        message,
                        type,
                        show: true
                    });

                    // Auto dismiss
                    setTimeout(() => {
                        const toast = this.toasts.find(t => t.id === id);
                        if (toast) toast.show = false;
                    }, 3000);

                    // Cleanup
                    setTimeout(() => {
                        this.toasts = this.toasts.filter(t => t.id !== id);
                    }, 3500);
                },

                async init() {
                    // Fetch Version Info
                    try {
                        const res = await fetch('http://localhost:8000/version');
                        const data = await res.json();
                        this.backendVersion = `Back: v${data.system_version} (${data.build_time})`;
                    } catch (e) {
                        console.error("Backend offline");
                        this.backendVersion = "Back: Offline";
                    }
                },

                get hasResults() {
                    return this.results !== null;
                },

                get filteredErrors() {
                    if (!this.results || !this.results.errors) return [];
                    const query = this.searchQuery.toLowerCase();
                    
                    let filtered = this.results.errors.filter(e => {
                        const matchesQuery = (e.message && e.message.toLowerCase().includes(query)) ||
                                           (e.sheet && e.sheet.toLowerCase().includes(query)) ||
                                           (e.column && e.column.toLowerCase().includes(query));
                        const matchesSheet = this.filterSheet === 'all' || e.sheet === this.filterSheet;
                        return matchesQuery && matchesSheet;
                    });

                    this.totalFiltered = filtered.length;
                    
                    const start = (this.currentPage - 1) * this.pageSize;
                    return filtered.slice(start, start + this.pageSize);
                },

                get totalPages() {
                    return Math.ceil(this.totalFiltered / this.pageSize) || 1;
                },

                totalFiltered: 0,

                // K-IFRS Summary Errors
                get kifrsSummaryErrors() {
                    if (!this.results || !this.results.errors) return [];
                    return this.results.errors.filter(e => e.row === 0 && e.rule_id && e.rule_id.startsWith('KIFRS_'));
                },

                // Get AI Explanation for an error
                async getAIExplanation(error) {
                    this.isExplanationLoading = true;
                    this.currentExplanation = { 
                        title: `AI 분석: ${error.column} 오류`,
                        explanation: 'AI가 오류를 분석하고 있습니다. 잠시만 기다려주세요...',
                        recommendation: ''
                    };
                    this.aiExplanationModalOpen = true;

                    try {
                        const response = await fetch('http://localhost:8000/errors/explain', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(error)
                        });

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.detail.message || 'AI 분석에 실패했습니다. 서버 로그를 확인하세요.');
                        }

                        const data = await response.json();
                        this.currentExplanation.explanation = data.explanation;
                        this.currentExplanation.recommendation = data.recommendation;

                    } catch (e) {
                        console.error(e);
                        this.currentExplanation.explanation = '오류에 대한 AI 설명을 가져오는 데 실패했습니다.';
                        this.currentExplanation.recommendation = e.message;
                    } finally {
                        this.isExplanationLoading = false;
                    }
                },

                // Helper: Get Rule Info for Sidebar
                getRuleInfo(ruleId) {
                    const rule = this.ruleFiles.find(r => r.id === ruleId);
                    if (!rule) return '';
                    return `${rule.file_name} (총 ${rule.total_rules_count}개 규칙)`;
                },

                // Helper: Get Applied Rules for a specific sheet
                getRulesForSheet(sheetName) {
                    if (!this.results || !this.results.rules_applied) return [];
                    return this.results.rules_applied.filter(r => r.source.sheet_name === sheetName);
                },

                // Helper: Get Top 5 Errors for a specific sheet
                getTopErrorsForSheet(sheetName) {
                    if (!this.results || !this.results.error_groups) return [];
                    return this.results.error_groups
                        .filter(g => g.sheet === sheetName)
                        .sort((a, b) => b.count - a.count)
                        .slice(0, 5);
                },

                // Helper: Get Summary for selected sheet safely
                getSelectedSheetSummary() {
                    if (!this.selectedSheet || !this.results || !this.results.metadata.sheets_summary) return null;
                    return this.results.metadata.sheets_summary[this.selectedSheet];
                },

                // Bulk Fix: 시트+컬럼 조합별 오류 집계
                getErrorsBySheetAndColumn() {
                    if (!this.results || !this.results.errors) return [];

                    // 시트+컬럼 조합으로 그룹화
                    const groupMap = {};

                    for (const error of this.results.errors) {
                        const sheet = error.sheet || '기본';
                        const col = error.column;
                        const key = `${sheet}::${col}`;  // 고유 키

                        if (!groupMap[key]) {
                            groupMap[key] = {
                                key: key,
                                sheet: sheet,
                                column: col,
                                count: 0,
                                sampleValues: [],
                                ruleTypes: new Set(),
                                messages: new Set(),
                                expectedFormats: new Set(),
                                // Fix detection flags (scan all items)
                                hasDatePattern: false,
                                hasCommaNumber: false,
                                hasGenderText: false
                            };
                        }

                        groupMap[key].count++;
                        
                        const valStr = String(error.actual_value || '').trim();
                        const lowerCol = col.toLowerCase();

                        // 1. Scan for Fixable Patterns (Date)
                        if (!groupMap[key].hasDatePattern) {
                            // 패턴 1: 구분자가 있는 날짜 (2023-1-1, 2023.01.01 등)
                            if (/^\d{4}\s*[-\/\.]\s*\d{1,2}\s*[-\/\.]\s*\d{1,2}(\s*[\.])?([T\s]+\d{1,2}:\d{1,2}(:\d{1,2})?)?/.test(valStr)) {
                                groupMap[key].hasDatePattern = true;
                            }
                            
                            // 패턴 2: 날짜 관련 컬럼명이면 무조건 활성화 (안전장치)
                            // 엑셀 시리얼 번호나 기타 변칙적인 경우도 일단 변환 시도를 허용함
                            if (lowerCol.includes('date') || lowerCol.includes('일자') || 
                                lowerCol.includes('입사일') || lowerCol.includes('생년월일') || 
                                lowerCol.includes('퇴사일') || lowerCol.includes('기준일')) {
                                groupMap[key].hasDatePattern = true;
                            }
                        }

                        // 2. Scan for Comma Numbers
                        if (!groupMap[key].hasCommaNumber) {
                            if (/^[\d,]+$/.test(valStr.replace(/\s/g, '')) && valStr.includes(',')) {
                                groupMap[key].hasCommaNumber = true;
                            }
                        }

                        // 3. Scan for Gender Text
                        if (!groupMap[key].hasGenderText) {
                            if (['남', '여', '남자', '여자', 'M', 'F', 'male', 'female'].includes(valStr.toLowerCase())) {
                                groupMap[key].hasGenderText = true;
                            }
                        }

                        // 샘플 값 수집 (최대 20개)
                        if (groupMap[key].sampleValues.length < 20 && error.actual_value !== null && error.actual_value !== undefined) {
                            if (!groupMap[key].sampleValues.includes(valStr)) {
                                groupMap[key].sampleValues.push(valStr);
                            }
                        }

                        // 규칙 타입 및 메시지 수집
                        if (error.rule_id) groupMap[key].ruleTypes.add(error.rule_id);
                        if (error.message) groupMap[key].messages.add(error.message);
                        if (error.expected) groupMap[key].expectedFormats.add(error.expected);
                    }

                    // 자동 수정 가능 여부 및 설명 결정
                    const result = Object.values(groupMap).map(item => {
                        const { autoFixable, fixDescription, fixType } = this.determineAutoFixability(item);
                        return {
                            ...item,
                            autoFixable,
                            fixDescription,
                            fixType,
                            ruleTypes: Array.from(item.ruleTypes),
                            messages: Array.from(item.messages),
                            expectedFormats: Array.from(item.expectedFormats)
                        };
                    });

                    // 시트명 → 건수 순으로 정렬
                    return result.sort((a, b) => {
                        if (a.sheet !== b.sheet) return a.sheet.localeCompare(b.sheet);
                        return b.count - a.count;
                    });
                },

                // 자동 수정 가능 여부 판단
                determineAutoFixability(group) {
                    const messages = Array.from(group.messages).join(' ').toLowerCase();
                    const colName = group.column.toLowerCase();

                    // 1. [최우선] 날짜 형식 패턴 감지 (전수 조사 결과 사용)
                    if (group.hasDatePattern) {
                        return { autoFixable: true, fixDescription: '날짜 형식 변환 (YYYY-MM-DD → YYYYMMDD)', fixType: 'date_format' };
                    }

                    // 2. [최우선] 숫자 형식 패턴 감지
                    if (group.hasCommaNumber && (messages.includes('숫자') || messages.includes('number') || messages.includes('금액') || colName.includes('금액') || colName.includes('wage') || colName.includes('pay'))) {
                         return { autoFixable: true, fixDescription: '숫자 형식 변환 (콤마/공백 제거)', fixType: 'number_format' };
                    }

                    // 3. 성별 코드 변환
                    if (group.hasGenderText || (messages.includes('성별') || messages.includes('허용값') || colName.includes('성별') || colName.includes('gender'))) {
                        // Double check if any gender text exists (using flag)
                        if (group.hasGenderText) {
                            return { autoFixable: true, fixDescription: '성별 코드 변환 (남→1, 여→2)', fixType: 'gender_code' };
                        }
                    }

                    // 4. 공백 제거
                    if (messages.includes('공백') || messages.includes('whitespace')) {
                        return { autoFixable: true, fixDescription: '앞뒤 공백 제거', fixType: 'trim' };
                    }

                    // 5. 그 외
                    if (messages.includes('중복') || messages.includes('duplicate')) {
                        return { autoFixable: false, fixDescription: '중복 오류 (수동 확인 필요)', fixType: 'duplicate' };
                    }

                    if (messages.includes('필수') || messages.includes('required') || messages.includes('비어')) {
                        return { autoFixable: false, fixDescription: '필수값 누락 (수동 입력 필요)', fixType: 'required' };
                    }

                    return { autoFixable: false, fixDescription: '자동 수정 불가', fixType: 'unknown' };
                },

                // 선택된 항목의 총 수정 건수
                getSelectedFixCount() {
                    const errorGroups = this.getErrorsBySheetAndColumn();
                    return this.selectedFixItems.reduce((sum, key) => {
                        const group = errorGroups.find(e => e.key === key);
                        return sum + (group ? group.count : 0);
                    }, 0);
                },

                // 자동 수정 가능한 항목이 하나라도 있는지 확인
                hasFixableItems() {
                    const groups = this.getErrorsBySheetAndColumn();
                    return groups.some(g => g.autoFixable);
                },

                // 시트+컬럼 키가 선택되었는지 확인
                isFixItemSelected(key) {
                    return this.selectedFixItems.includes(key);
                },

                // 시트+컬럼 선택 토글
                toggleFixItem(key, autoFixable) {
                    if (!autoFixable) return;
                    const idx = this.selectedFixItems.indexOf(key);
                    if (idx === -1) {
                        this.selectedFixItems.push(key);
                    } else {
                        this.selectedFixItems.splice(idx, 1);
                    }
                },

                // 고유 시트 목록 가져오기
                getUniqueSheets() {
                    const groups = this.getErrorsBySheetAndColumn();
                    return [...new Set(groups.map(g => g.sheet))].sort();
                },

                // 시트 필터링된 오류 목록
                getFilteredErrorsBySheetAndColumn() {
                    const groups = this.getErrorsBySheetAndColumn();
                    if (this.fixFilterSheet === 'all') return groups;
                    return groups.filter(g => g.sheet === this.fixFilterSheet);
                },

                // 자동 수정 가능한 항목 전체 선택
                selectAllFixableItems() {
                    const groups = this.getFilteredErrorsBySheetAndColumn();
                    const fixableKeys = groups.filter(g => g.autoFixable).map(g => g.key);
                    // 기존 선택에 추가 (중복 제거)
                    this.selectedFixItems = [...new Set([...this.selectedFixItems, ...fixableKeys])];
                },

                // 미리보기 생성 (프론트엔드에서 시뮬레이션)
                generateFixPreview() {
                    if (this.selectedFixItems.length === 0) {
                        this.fixPreview = { total: 0, success: 0, fail: 0, successRate: 0, items: [] };
                        return;
                    }

                    const errorGroups = this.getErrorsBySheetAndColumn();
                    const selectedGroups = this.selectedFixItems.map(key => errorGroups.find(e => e.key === key)).filter(Boolean);

                    const previewItems = [];
                    let successCount = 0;
                    let failCount = 0;

                    // 선택된 오류들에 대해 미리보기 생성
                    for (const error of this.results.errors) {
                        const key = `${error.sheet || '기본'}::${error.column}`;
                        if (!this.selectedFixItems.includes(key)) continue;

                        const group = selectedGroups.find(g => g.key === key);
                        const fixType = group?.fixType || 'unknown';
                        const beforeValue = error.actual_value;
                        const afterValue = this.simulateFixValue(beforeValue, fixType);
                        const success = afterValue !== null && afterValue !== beforeValue;

                        previewItems.push({
                            sheet: error.sheet || '기본',
                            column: error.column,
                            row: error.row,
                            before: String(beforeValue ?? ''),
                            after: String(afterValue ?? beforeValue ?? ''),
                            success: success,
                            fixType: fixType
                        });

                        if (success) successCount++;
                        else failCount++;
                    }

                    const total = previewItems.length;
                    this.fixPreview = {
                        total: total,
                        success: successCount,
                        fail: failCount,
                        successRate: total > 0 ? Math.round((successCount / total) * 100) : 0,
                        items: previewItems
                    };
                },

                // 값 변환 시뮬레이션 (프론트엔드)
                simulateFixValue(value, fixType) {
                    if (value === null || value === undefined) return null;
                    const strValue = String(value).trim();

                    if (fixType === 'date_format') {
                        // YYYY. 1. 1 or 2023-01-01T00... -> YYYYMMDD
                        // 숫자 부분만 추출하여 처리
                        const match = strValue.match(/^(\d{4})\s*[-\/\.]\s*(\d{1,2})\s*[-\/\.]\s*(\d{1,2})/);
                        if (match) {
                            const year = match[1];
                            const month = match[2].padStart(2, '0');
                            const day = match[3].padStart(2, '0');
                            return `${year}${month}${day}`;
                        }
                        return null;
                    }

                    if (fixType === 'gender_code') {
                        const genderMap = {
                            '남': '1', '남자': '1', 'm': '1', 'male': '1', 'M': '1',
                            '여': '2', '여자': '2', 'f': '2', 'female': '2', 'F': '2'
                        };
                        return genderMap[strValue] || null;
                    }

                    if (fixType === 'number_format') {
                        const cleaned = strValue.replace(/[,\s]/g, '');
                        if (/^\d+$/.test(cleaned)) return cleaned;
                        return null;
                    }

                    if (fixType === 'trim') {
                        return strValue;
                    }

                    return null;
                },

                // 필터링된 미리보기 항목
                getFilteredPreviewItems() {
                    if (!this.fixPreview.items) return [];
                    if (this.fixPreviewFilter === 'all') return this.fixPreview.items;
                    if (this.fixPreviewFilter === 'success') return this.fixPreview.items.filter(i => i.success);
                    if (this.fixPreviewFilter === 'fail') return this.fixPreview.items.filter(i => !i.success);
                    return this.fixPreview.items;
                },

                // 수정된 파일 다운로드
                async downloadFixedFile() {
                    if (this.selectedFixItems.length === 0) return;
                    if (!this.fileA) {
                        this.showToast('원본 파일이 필요합니다. 파일을 다시 업로드해주세요.', 'error');
                        return;
                    }

                    this.isDownloading = true;

                    try {
                        // 선택된 시트+컬럼 조합의 수정 정보 수집
                        const errorGroups = this.getErrorsBySheetAndColumn();
                        const selectedGroups = this.selectedFixItems.map(key => {
                            return errorGroups.find(e => e.key === key);
                        }).filter(Boolean);

                        // 오류 데이터에서 수정할 셀 정보 추출 (선택된 시트+컬럼만)
                        const cellsToFix = this.results.errors
                            .filter(e => {
                                const key = `${e.sheet || '기본'}::${e.column}`;
                                return this.selectedFixItems.includes(key);
                            })
                            .map(e => {
                                const key = `${e.sheet || '기본'}::${e.column}`;
                                const group = selectedGroups.find(g => g.key === key);
                                return {
                                    sheet: e.sheet,
                                    row: e.row,
                                    column: e.column,
                                    currentValue: e.actual_value,
                                    fixType: group?.fixType || 'unknown'
                                };
                            });

                        // FormData로 파일과 함께 전송
                        const formData = new FormData();
                        formData.append('original_file', this.fileA);
                        formData.append('cells_to_fix_json', JSON.stringify(cellsToFix));

                        const response = await fetch('http://localhost:8000/api/fix/download', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            throw new Error(errorData.detail?.message || '파일 생성 실패');
                        }

                        // Blob으로 파일 다운로드
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `수정완료_${this.fileA?.name || 'data'}_${new Date().toISOString().slice(0,10)}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);

                        this.showToast(`${this.selectedFixItems.length}개 항목, ${this.getSelectedFixCount()}건 수정 완료`, 'success');

                    } catch (error) {
                        console.error('Download error:', error);
                        this.showToast('파일 다운로드 실패: ' + error.message, 'error');
                    } finally {
                        this.isDownloading = false;
                    }
                },

                resetResults() {
                    this.results = null;
                    this.dbErrors = null;
                    this.selectedSheet = null;
                    this.fixSuggestions = [];
                    this.selectedFixes = [];
                    this.fixPreview = { total: 0, success: 0, fail: 0, successRate: 0, items: [] };
                    this.selectedFixItems = []; // Clear manual fix selections
                    this.searchQuery = '';
                    
                    // Destroy Charts
                    if (window.myChart) {
                        window.myChart.destroy();
                        window.myChart = null;
                    }
                },

                handleFileSelect(event, type) {
                    const file = event.target.files[0];
                    if (file) {
                        if (type === 'A') {
                            this.resetResults(); // Reset on new file A
                            this.fileA = file;
                            this.autoStartValidation();
                        }
                        if (type === 'B') this.fileB = file;
                    }
                },

                handleDrop(event, type) {
                    this[type === 'A' ? 'dragOverA' : 'dragOverB'] = false;
                    const file = event.dataTransfer.files[0];
                    if (file) {
                        if (type === 'A') {
                            this.resetResults(); // Reset on new file A
                            this.fileA = file;
                            this.autoStartValidation();
                        }
                        if (type === 'B') this.fileB = file;
                    }
                },

                autoStartValidation() {
                    // 규칙이 선택되어 있으면 자동으로 검증 시작
                    if (this.selectedSavedRuleId && !this.isLoading) {
                        setTimeout(() => this.validateFiles(), 100);
                    }
                },

                async validateFiles() {
                    if (!this.fileA) return;
                    if (!this.useSavedRule && !this.fileB) return;
                    if (this.useSavedRule && !this.selectedSavedRuleId) return;

                    this.resetResults(); // Ensure reset before validation starts
                    this.isLoading = true;
                    const formData = new FormData();
                    formData.append('employee_file', this.fileA);

                    try {
                        let url = '';
                        
                        if (this.useSavedRule) {
                            // Step 2 Logic: Use saved rules from DB
                            url = `http://localhost:8000/validate-with-db-rules?rule_file_id=${this.selectedSavedRuleId}`;
                        } else {
                            // Legacy Logic: Upload new rules file
                            url = 'http://localhost:8000/validate';
                            formData.append('rules_file', this.fileB);
                        }

                        const response = await fetch(url, {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            throw new Error(err.detail?.message || 'Validation Failed');
                        }

                        const data = await response.json();
                        
                        // Handle structure difference between endpoints
                        if (this.useSavedRule) {
                            const sessionId = data.session_id;
                            const sessionRes = await fetch(`http://localhost:8000/sessions/${sessionId}`);
                            const sessionData = await sessionRes.json();

                            // Check where full_results is located
                            // validation_service.py stores it in the 'full_results' column of the session table
                            const fullResults = sessionData.session.full_results;

                            if (fullResults) {
                                // Store DB errors separately for AI fix suggestions
                                this.dbErrors = sessionData.errors || [];

                                // If full_results (JSON) is preserved, use it directly
                                this.results = {
                                    summary: fullResults.summary,
                                    errors: fullResults.errors,
                                    error_groups: fullResults.error_groups,
                                    rules_applied: fullResults.rules_applied,
                                    metadata: {
                                        ...(fullResults.metadata || {}),
                                        session_id: sessionId  // CRITICAL: Add session_id
                                    }
                                };
                            } else {
                                // Fallback: If full_results is missing, use errors from DB join
                                // Note: This might lack error_groups and metadata unless we reconstruct them
                                console.warn("full_results missing in session, using raw errors");
                                this.results = {
                                    summary: {
                                        total_rows: sessionData.session.total_rows,
                                        valid_rows: sessionData.session.valid_rows,
                                        error_rows: sessionData.session.error_rows,
                                        total_errors: sessionData.session.total_errors,
                                        rules_applied: sessionData.session.rules_applied_count,
                                        timestamp: sessionData.session.created_at
                                    },
                                    errors: sessionData.errors.map(e => ({
                                        sheet: e.sheet_name,
                                        row: e.row_number,
                                        column: e.column_name,
                                        rule_id: e.rule_id,
                                        message: e.error_message,
                                        actual_value: e.actual_value,
                                        expected: e.expected_value,
                                        source_rule: e.source_rule_text,
                                        id: e.id, // Keep DB ID for feedback
                                        session_id: sessionId
                                    })),
                                    error_groups: [], // TODO: Re-group if needed
                                    rules_applied: [],
                                    metadata: {
                                        session_id: sessionId  // CRITICAL: Add session_id
                                    }
                                };
                            }
                            
                            // Add DB session ID to metadata for feedback
                            if (!this.results.metadata) this.results.metadata = {};
                            this.results.metadata.session_id = sessionId;

                        } else {
                            this.results = data;
                        }
                        
                        // 기본 선택 시트 설정 (첫 번째 시트)
                        if (this.results.metadata) {
                            if (this.results.metadata.sheet_order && this.results.metadata.sheet_order.length > 0) {
                                this.selectedSheet = this.results.metadata.sheet_order[0];
                            } else if (this.results.metadata.sheets_summary) {
                                const sheets = Object.keys(this.results.metadata.sheets_summary);
                                if (sheets.length > 0) {
                                    this.selectedSheet = sheets[0];
                                }
                            }
                        }

                        this.currentTab = 'dashboard';
                        
                        // Wait for DOM update then render charts
                        this.$nextTick(() => {
                            this.renderCharts();
                        });

                    } catch (error) {
                        alert('오류가 발생했습니다: ' + error.message);
                        console.error(error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                // =================================================================
                // AI & Feedback Functions
                // =================================================================

                async interpretRules(fileId) {
                    if (!confirm('AI 해석을 시작하시겠습니까? 약 10-20초 정도 소요됩니다.')) return;
                    
                    try {
                        const response = await fetch(`http://localhost:8000/rules/interpret/${fileId}`, {
                            method: 'POST'
                        });
                        
                        if (!response.ok) throw new Error('AI 해석 실패');
                        
                        const result = await response.json();
                        alert(`AI 해석 완료!\n\n총 규칙: ${result.total_rules}\n해석됨: ${result.interpreted_rules}`);
                        
                        // Refresh details if open
                        if (this.ruleFileDetails && this.ruleFileDetails.id === fileId) {
                            this.viewRuleFileDetails(fileId);
                        }
                        // Refresh list
                        this.loadRuleFiles();
                        
                    } catch (e) {
                        alert('오류: ' + e.message);
                    }
                },

                openFeedbackModal(error) {
                    this.selectedError = error;
                    this.feedbackReason = '';
                    this.feedbackModalOpen = true;
                },

                async submitFeedback() {
                    if (!this.feedbackReason.trim()) {
                        alert('신고 사유를 입력해주세요.');
                        return;
                    }

                    try {
                        const payload = {
                            error_id: "00000000-0000-0000-0000-000000000000", // UUID placeholder required if error obj doesn't have ID yet?
                            // Wait, standard validation response (ValidationResponse model) errors might not have DB UUIDs if they are just generated.
                            // But for DB-based validation (Step 2), we DO save errors to DB.
                            // If this is from legacy validation, we can't save feedback effectively linked to a DB record.
                            // Feedback only works for DB-based validation sessions.
                            
                            // Let's verify if 'error' object has an ID.
                            // In ValidationService, we create errors batch but do we return the IDs?
                            // The session detail API returns errors from DB, so they SHOULD have IDs.
                            // Legacy validation does NOT return IDs.
                            
                            // We need to handle this.
                            rule_id: this.selectedError.rule_id,
                            field_name: this.selectedError.column,
                            error_message: this.selectedError.message,
                            actual_value: String(this.selectedError.actual_value),
                            is_false_positive: true,
                            user_explanation: this.feedbackReason,
                            feedback_by: "user" // Hardcoded for now
                        };
                        
                        // If error has ID (from session API), use it
                        if (this.selectedError.id) {
                            payload.error_id = this.selectedError.id;
                            payload.session_id = this.selectedError.session_id;
                        } else {
                            // If legacy validation, we can't really link it.
                            // But let's send what we have.
                             // For now, let's just alert if no ID.
                             console.warn("No error ID found. This might be a legacy validation run.");
                             // Generate a dummy ID for now or handle in backend? 
                             // Backend expects UUID.
                        }

                        const response = await fetch('http://localhost:8000/feedback/false-positive', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) throw new Error('피드백 전송 실패');
                        
                        alert('소중한 피드백 감사합니다. AI 모델 개선에 반영됩니다.');
                        this.feedbackModalOpen = false;
                        
                    } catch (e) {
                        alert('오류: ' + e.message);
                    }
                },

                // =================================================================
                // Statistics Functions
                // =================================================================

                statistics: null,
                learningStats: null,

                async loadLearningStats() {
                    try {
                        const response = await fetch('http://localhost:8000/learning/statistics');
                        if (!response.ok) throw new Error('학습 통계 로딩 실패');
                        this.learningStats = await response.json();
                    } catch (e) {
                        console.error('Learning stats error:', e);
                    }
                },

                async loadStatistics() {
                    try {
                        const response = await fetch('http://localhost:8000/statistics/dashboard');
                        if (!response.ok) throw new Error('통계 로딩 실패');
                        
                        this.statistics = await response.json();
                        
                        this.$nextTick(() => {
                            this.renderTrendChart();
                        });
                    } catch (e) {
                        console.error('Stats error:', e);
                        // alert('통계 데이터를 불러오는데 실패했습니다.');
                    }
                },

                renderTrendChart() {
                    if (!this.statistics || !this.statistics.recent_trend) return;
                    
                    const ctx = document.getElementById('trendChart');
                    if (!ctx) return;
                    
                    if (window.trendChartInstance) {
                        window.trendChartInstance.destroy();
                    }

                    const data = this.statistics.recent_trend;
                    const labels = data.map(d => d.date);
                    const values = data.map(d => d.errors);

                    window.trendChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: '발생 오류 수',
                                data: values,
                                borderColor: '#0ea5e9',
                                backgroundColor: 'rgba(14, 165, 233, 0.1)',
                                tension: 0.3,
                                fill: true,
                                pointBackgroundColor: '#ffffff',
                                pointBorderColor: '#0ea5e9',
                                pointBorderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
                                x: { grid: { display: false } }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                },

                calculateComplianceRate() {
                    if (!this.results) return 0;
                    const total = this.results.summary.total_rows;
                    const valid = this.results.summary.valid_rows;
                    return total > 0 ? Math.round((valid / total) * 100) : 0;
                },

                renderCharts() {
                    if (!this.results || !this.results.metadata || !this.results.metadata.sheets_summary) {
                        console.warn("No sheet summary data available for charts.");
                        return;
                    }

                    const ctx = document.getElementById('sheetChart');
                    if (!ctx) return;
                    
                    if (window.myChart) {
                        window.myChart.destroy();
                    }

                    const sheets = this.results.metadata.sheets_summary;
                    // Use sheet_order if available for consistent ordering
                    const labels = (this.results.metadata.sheet_order && this.results.metadata.sheet_order.length > 0)
                        ? this.results.metadata.sheet_order.filter(name => sheets[name]) // Ensure sheet exists in summary
                        : Object.keys(sheets).map(name => String(name));
                    
                    const errorData = labels.map(l => sheets[l].error_rows || 0);
                    const validData = labels.map(l => sheets[l].valid_rows || 0);

                    console.log("Rendering Chart:", { labels, errorData, validData });

                    window.myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: '오류 행',
                                    data: errorData,
                                    backgroundColor: '#ef4444',
                                    borderRadius: 4
                                },
                                {
                                    label: '정상 행',
                                    data: validData,
                                    backgroundColor: '#22c55e',
                                    borderRadius: 4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: { stacked: true, grid: { display: false } },
                                y: { stacked: true, grid: { color: '#f1f5f9' } }
                            },
                            plugins: {
                                legend: { position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            return context[0].label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                },

                async downloadExcel() {
                    if (!this.results) return;

                    try {
                        const response = await fetch('http://localhost:8000/download-results', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.results)
                        });

                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `DBO_Validation_Result_${new Date().toISOString().slice(0,10)}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    } catch (e) {
                        alert('다운로드 실패');
                    }
                },

                // =================================================================
                // Rules Management Functions
                // =================================================================

                async loadRuleFiles() {
                    try {
                        const response = await fetch('http://localhost:8000/rules/files?status=active&limit=50');
                        const data = await response.json();

                        // 중복 제거: 같은 파일명+버전 조합의 경우 최신 것만 유지
                        const fileMap = new Map();

                        for (const file of data) {
                            const key = `${file.file_name}_${file.file_version}`;
                            const existing = fileMap.get(key);

                            if (!existing || new Date(file.uploaded_at) > new Date(existing.uploaded_at)) {
                                fileMap.set(key, file);
                            }
                        }

                        // Map을 배열로 변환하고 업로드 날짜 기준 정렬
                        this.ruleFiles = Array.from(fileMap.values())
                            .sort((a, b) => new Date(b.uploaded_at) - new Date(a.uploaded_at));

                        // Auto-select first rule if nothing selected
                        if (!this.selectedSavedRuleId && this.ruleFiles.length > 0) {
                            this.selectedSavedRuleId = this.ruleFiles[0].id;
                        }

                        console.log(`Loaded ${this.ruleFiles.length} unique rule files`);
                    } catch (e) {
                        console.error('Failed to load rule files:', e);
                        alert('규칙 파일 목록 로딩 실패');
                    }
                },

                handleRuleFileSelect(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.ruleFileToUpload = file;
                    }
                },

                async uploadRuleFileToDb() {
                    if (!this.ruleFileToUpload) {
                        alert('업로드할 파일을 선택하세요');
                        return;
                    }

                    this.uploadingRuleFile = true;

                    try {
                        const formData = new FormData();
                        formData.append('rules_file', this.ruleFileToUpload);
                        formData.append('file_version', this.ruleFileVersion);
                        formData.append('uploaded_by', this.ruleFileUploadedBy);
                        if (this.ruleFileNotes) {
                            formData.append('notes', this.ruleFileNotes);
                        }

                        const response = await fetch('http://localhost:8000/rules/upload-to-db', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail?.message || '업로드 실패');
                        }

                        const result = await response.json();

                        // Check if version was auto-incremented
                        const versionNote = result.file_version !== this.ruleFileVersion
                            ? `\n\n⚠ 중복 파일이 감지되어 버전이 자동으로 증가되었습니다: ${this.ruleFileVersion} → ${result.file_version}`
                            : '';

                        alert(`✓ 규칙 파일이 성공적으로 업로드되었습니다!\n\n파일명: ${result.file_name}\n버전: ${result.file_version}\n총 규칙 수: ${result.total_rules_count}${versionNote}`);

                        // Reset form
                        this.ruleFileToUpload = null;
                        this.ruleFileVersion = '1.0';
                        this.ruleFileUploadedBy = 'system';
                        this.ruleFileNotes = '';

                        // Reset file input (handle both old ID and new x-ref)
                        const oldInput = document.getElementById('ruleFileInput');
                        if (oldInput) oldInput.value = '';
                        if (this.$refs.ruleFileInputNew) this.$refs.ruleFileInputNew.value = '';

                        // Reload rule files list and auto-select the newly uploaded file
                        await this.loadRuleFiles();

                        // Auto-select the newly uploaded file and go to mapping review
                        if (result.id) {
                            this.selectedSavedRuleId = result.id;
                            this.selectedRuleFile = result.id;
                            console.log(`Auto-selected newly uploaded rule file: ${result.id}`);

                            // Auto-navigate to mapping review
                            this.showToast('업로드 완료! 매핑 검토 화면으로 이동합니다.', 'success');
                            await this.goToMappingReview();
                        }
                    } catch (e) {
                        console.error('Upload error:', e);
                        this.showToast(`업로드 실패: ${e.message}`, 'error');
                    } finally {
                        this.uploadingRuleFile = false;
                    }
                },

                async viewRuleFileDetails(fileId) {
                    try {
                        const response = await fetch(`http://localhost:8000/rules/files/${fileId}`);
                        if (!response.ok) throw new Error('파일 정보를 가져올 수 없습니다');

                        const data = await response.json();
                        this.ruleFileDetails = data;
                        this.selectedRuleFile = fileId;
                        this.currentTab = 'rule_detail';
                    } catch (e) {
                        console.error('Failed to load rule file details:', e);
                        alert('파일 상세 정보 로딩 실패: ' + e.message);
                    }
                },

                closeRuleFileDetails() {
                    this.ruleFileDetails = null;
                    this.selectedRuleFile = null;
                    this.currentTab = 'rules'; // Go back to list
                },

                async downloadRuleFile(fileId, fileName) {
                    try {
                        console.log('Downloading file:', fileId);

                        const response = await fetch(`http://localhost:8000/rules/download/${fileId}`);

                        console.log('Response status:', response.status);
                        console.log('Response headers:', response.headers);

                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Download error response:', errorText);
                            throw new Error(`다운로드 실패: ${response.status} - ${errorText}`);
                        }

                        const blob = await response.blob();
                        console.log('Blob size:', blob.size, 'type:', blob.type);

                        if (blob.size === 0) {
                            throw new Error('다운로드된 파일이 비어있습니다');
                        }

                        // Get filename from Content-Disposition header if available
                        const contentDisposition = response.headers.get('Content-Disposition');
                        let downloadFileName = fileName || `rules_${fileId}.xlsx`;

                        if (contentDisposition) {
                            const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                            if (matches != null && matches[1]) {
                                downloadFileName = matches[1].replace(/['"]/g, '');
                            }
                        }

                        console.log('Download filename:', downloadFileName);

                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = downloadFileName;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);

                        console.log('Download completed successfully');
                    } catch (e) {
                        console.error('Download error:', e);
                        alert(`다운로드 실패: ${e.message}`);
                    }
                },

                async reinterpretRules(fileId) {
                    // 재해석 확인 다이얼로그
                    const confirmed = confirm(
                        '규칙을 재해석하시겠습니까?\n\n' +
                        '• 기존 AI 해석 결과가 모두 초기화됩니다\n' +
                        '• 로컬 파서로 재해석하여 AI 오류를 방지합니다\n' +
                        '• 저장된 원본 파일을 사용합니다'
                    );

                    if (!confirmed) return;

                    try {
                        this.showToast('규칙 재해석 중...', 'info');

                        const response = await fetch(
                            `http://localhost:8000/rules/reinterpret/${fileId}?use_local_parser=true`,
                            { method: 'POST' }
                        );

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail?.message || '재해석 실패');
                        }

                        const result = await response.json();

                        this.showToast(
                            `재해석 완료: ${result.interpreted_rules}/${result.total_rules}개 규칙 (${result.engine_used} 엔진)`,
                            'success'
                        );

                        // 목록 새로고침
                        await this.loadRuleFiles();

                    } catch (e) {
                        console.error('Re-interpretation error:', e);
                        alert(`재해석 실패: ${e.message}`);
                    }
                },

                // =================================================================
                // Rule Mapping Functions (NEW)
                // =================================================================

                selectRuleFile(fileId) {
                    this.selectedRuleFile = fileId;
                    this.selectedSavedRuleId = fileId; // Also set for validation use
                },

                async goToMappingReview() {
                    if (!this.selectedRuleFile) return;

                    this.ruleManagementStep = 2;
                    await this.loadRuleMappings(this.selectedRuleFile);
                    await this.viewRuleFileDetails(this.selectedRuleFile);
                },

                async loadRuleMappings(fileId) {
                    this.ruleMappingsLoading = true;
                    this.ruleMappings = null;

                    try {
                        const response = await fetch(`http://localhost:8000/rules/files/${fileId}/mappings`);
                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail?.message || '매핑 조회 실패');
                        }

                        this.ruleMappings = await response.json();
                        console.log('Loaded mappings:', this.ruleMappings);
                    } catch (e) {
                        console.error('Load mappings error:', e);
                        this.showToast(`매핑 조회 실패: ${e.message}`, 'error');
                    } finally {
                        this.ruleMappingsLoading = false;
                    }
                },

                async reinterpretRulesAndRefresh() {
                    if (!this.selectedRuleFile) return;
                    await this.reinterpretRules(this.selectedRuleFile);
                    await this.loadRuleMappings(this.selectedRuleFile);
                },

                getFilteredMappingSheets() {
                    if (!this.ruleMappings?.sheets) return [];

                    if (this.selectedMappingSheet === 'all') {
                        return this.ruleMappings.sheets;
                    }
                    return this.ruleMappings.sheets.filter(s => s.sheet_name === this.selectedMappingSheet);
                },

                getFilteredRules(rules) {
                    if (!rules) return [];

                    if (this.mappingFilterStatus === 'all') {
                        return rules;
                    }
                    return rules.filter(r => r.mapping_status === this.mappingFilterStatus);
                },

                openMappingEditor(rule) {
                    // Deep copy to avoid modifying original
                    this.editingMapping = JSON.parse(JSON.stringify(rule));

                    // Initialize helper fields for parameter editing
                    const params = this.editingMapping.ai_parameters || {};

                    // Format type detection
                    if (this.editingMapping.ai_rule_type === 'format') {
                        if (params.format) {
                            this.editingMapping._formatType = 'date';
                            this.editingMapping._dateFormat = params.format;
                        } else if (params.allowed_values) {
                            this.editingMapping._formatType = 'allowed';
                            this.editingMapping._allowedValues = params.allowed_values.join(', ');
                        } else if (params.regex) {
                            this.editingMapping._formatType = 'regex';
                            this.editingMapping._regexPattern = params.regex;
                        } else {
                            this.editingMapping._formatType = 'date';
                            this.editingMapping._dateFormat = 'YYYYMMDD';
                        }
                    }

                    // Range params
                    if (this.editingMapping.ai_rule_type === 'range') {
                        this.editingMapping._minValue = params.min_value || '';
                        this.editingMapping._maxValue = params.max_value || '';
                    }

                    // Date logic params
                    if (this.editingMapping.ai_rule_type === 'date_logic') {
                        this.editingMapping._compareField = params.compare_field || '';
                        this.editingMapping._dateOperator = params.operator || 'greater_than';
                    }

                    // Custom/cross_field params
                    if (this.editingMapping.ai_rule_type === 'custom' || this.editingMapping.ai_rule_type === 'cross_field') {
                        this.editingMapping._rawParams = JSON.stringify(params, null, 2);
                    }

                    // Composite params - initialize _validations from params.validations
                    if (this.editingMapping.ai_rule_type === 'composite') {
                        const validations = params.validations || [];
                        this.editingMapping._validations = validations.map(v => {
                            const item = { type: v.type, parameters: v.parameters || {} };
                            // Initialize helper fields
                            if (v.type === 'format') {
                                if (v.parameters?.format) {
                                    item._formatValue = v.parameters.format;
                                } else if (v.parameters?.allowed_values) {
                                    item._formatValue = v.parameters.allowed_values.join(', ');
                                } else if (v.parameters?.regex) {
                                    item._formatValue = v.parameters.regex;
                                }
                            } else if (v.type === 'range') {
                                item._minVal = v.parameters?.min_value || '';
                                item._maxVal = v.parameters?.max_value || '';
                            }
                            return item;
                        });
                    } else {
                        this.editingMapping._validations = [];
                    }

                    // Default confidence
                    if (!this.editingMapping.ai_confidence_score) {
                        this.editingMapping.ai_confidence_score = 1.0;
                    }
                },

                updateFormatParams() {
                    const type = this.editingMapping._formatType;

                    if (type === 'date') {
                        const fmt = this.editingMapping._dateFormat || 'YYYYMMDD';
                        const regex = fmt === 'YYYYMMDD'
                            ? '^(19|20)\\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\\d|3[01])$'
                            : '^\\d{4}-\\d{2}-\\d{2}$';
                        this.editingMapping.ai_parameters = { format: fmt, regex: regex };
                    } else if (type === 'allowed') {
                        const values = (this.editingMapping._allowedValues || '').split(',').map(v => v.trim()).filter(v => v);
                        this.editingMapping.ai_parameters = { allowed_values: values };
                    } else if (type === 'regex') {
                        this.editingMapping.ai_parameters = { regex: this.editingMapping._regexPattern || '' };
                    }
                },

                updateRangeParams() {
                    this.editingMapping.ai_parameters = {};
                    if (this.editingMapping._minValue !== '' && this.editingMapping._minValue !== null) {
                        this.editingMapping.ai_parameters.min_value = parseFloat(this.editingMapping._minValue);
                    }
                    if (this.editingMapping._maxValue !== '' && this.editingMapping._maxValue !== null) {
                        this.editingMapping.ai_parameters.max_value = parseFloat(this.editingMapping._maxValue);
                    }
                },

                updateDateLogicParams() {
                    this.editingMapping.ai_parameters = {
                        compare_field: this.editingMapping._compareField || '',
                        operator: this.editingMapping._dateOperator || 'greater_than'
                    };
                },

                updateCustomParams() {
                    try {
                        this.editingMapping.ai_parameters = JSON.parse(this.editingMapping._rawParams || '{}');
                    } catch (e) {
                        // Invalid JSON, keep as is
                    }
                },

                // Composite validation functions
                addCompositeValidation() {
                    if (!this.editingMapping._validations) {
                        this.editingMapping._validations = [];
                    }
                    this.editingMapping._validations.push({
                        type: 'required',
                        parameters: {},
                        _formatValue: '',
                        _minVal: '',
                        _maxVal: ''
                    });
                    this.updateCompositeParams();
                },

                removeCompositeValidation(idx) {
                    if (this.editingMapping._validations) {
                        this.editingMapping._validations.splice(idx, 1);
                        this.updateCompositeParams();
                    }
                },

                updateCompositeParams() {
                    if (!this.editingMapping._validations) return;

                    const validations = this.editingMapping._validations.map(v => {
                        const result = {
                            type: v.type,
                            parameters: {},
                            error_message: ''
                        };

                        if (v.type === 'required') {
                            result.error_message = '{field_name}은(는) 필수 입력 항목입니다.';
                        } else if (v.type === 'no_duplicates') {
                            result.error_message = '{field_name}이(가) 중복되었습니다.';
                        } else if (v.type === 'format') {
                            const val = (v._formatValue || '').trim();
                            if (val.toUpperCase() === 'YYYYMMDD') {
                                result.parameters = {
                                    format: 'YYYYMMDD',
                                    regex: '^(19|20)\\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\\d|3[01])$'
                                };
                                result.error_message = '{field_name} 형식이 올바르지 않습니다. (YYYYMMDD)';
                            } else if (val.includes(',')) {
                                // Allowed values
                                const allowed = val.split(',').map(s => s.trim()).filter(s => s);
                                result.parameters = { allowed_values: allowed };
                                result.error_message = '{field_name} 값이 올바르지 않습니다. (허용: ' + allowed.join(', ') + ')';
                            } else if (val) {
                                // Treat as regex
                                result.parameters = { regex: val };
                                result.error_message = '{field_name} 형식이 올바르지 않습니다.';
                            }
                        } else if (v.type === 'range') {
                            if (v._minVal !== '' && v._minVal !== null) {
                                result.parameters.min_value = parseFloat(v._minVal);
                            }
                            if (v._maxVal !== '' && v._maxVal !== null) {
                                result.parameters.max_value = parseFloat(v._maxVal);
                            }
                            const msgs = [];
                            if (result.parameters.min_value !== undefined) msgs.push(result.parameters.min_value + ' 이상');
                            if (result.parameters.max_value !== undefined) msgs.push(result.parameters.max_value + ' 이하');
                            result.error_message = '{field_name} 값은 ' + msgs.join(', ') + '이어야 합니다.';
                        }

                        return result;
                    });

                    this.editingMapping.ai_parameters = { validations: validations };
                },

                async saveMappingEdit() {
                    if (!this.editingMapping || !this.editingMapping.ai_rule_type) {
                        this.showToast('검증 유형을 선택하세요.', 'error');
                        return;
                    }

                    try {
                        // Prepare AI parameters based on type if not set
                        let aiParams = this.editingMapping.ai_parameters || {};
                        let summary = '사용자 수동 설정';

                        if (this.editingMapping.ai_rule_type === 'required' || this.editingMapping.ai_rule_type === 'no_duplicates') {
                            aiParams = {};
                        }

                        // Composite type - validate and set summary
                        if (this.editingMapping.ai_rule_type === 'composite') {
                            const validations = aiParams.validations || [];
                            if (validations.length === 0) {
                                this.showToast('복합 검증에는 최소 하나의 조건이 필요합니다.', 'error');
                                return;
                            }
                            const types = validations.map(v => {
                                if (v.type === 'required') return '필수';
                                if (v.type === 'no_duplicates') return '중복불가';
                                if (v.type === 'format') return '형식';
                                if (v.type === 'range') return '범위';
                                return v.type;
                            });
                            summary = '복합: ' + types.join(' + ');
                        }

                        const payload = {
                            // Original rule info (editable now)
                            sheet_name: this.editingMapping.sheet_name,
                            field_name: this.editingMapping.field_name,
                            rule_text: this.editingMapping.rule_text,
                            row_number: parseInt(this.editingMapping.row_number) || null,
                            column_letter: this.editingMapping.column_letter?.toUpperCase() || null,
                            is_common: this.editingMapping.is_common || false, // Add is_common
                            // AI interpretation settings
                            ai_rule_type: this.editingMapping.ai_rule_type,
                            ai_parameters: aiParams,
                            ai_error_message: this.editingMapping.ai_error_message || `{field_name} 검증 실패`,
                            ai_confidence_score: parseFloat(this.editingMapping.ai_confidence_score) || 1.0,
                            ai_interpretation_summary: summary
                        };

                        const response = await fetch(`http://localhost:8000/rules/${this.editingMapping.id}/mapping`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail?.message || '매핑 저장 실패');
                        }

                        this.showToast('규칙이 저장되었습니다.', 'success');
                        this.editingMapping = null;

                        // Refresh mappings
                        await this.loadRuleMappings(this.selectedRuleFile);

                    } catch (e) {
                        console.error('Save mapping error:', e);
                        this.showToast(`저장 실패: ${e.message}`, 'error');
                    }
                },

                // Reinterpret a single rule based on its rule_text
                async reinterpretSingleRule() {
                    if (!this.editingMapping) return;

                    this.reinterpretingRule = true;
                    try {
                        // First save the current original rule info
                        const savePayload = {
                            sheet_name: this.editingMapping.sheet_name,
                            field_name: this.editingMapping.field_name,
                            rule_text: this.editingMapping.rule_text,
                            row_number: parseInt(this.editingMapping.row_number) || null,
                            column_letter: this.editingMapping.column_letter?.toUpperCase() || null
                        };

                        // Save original rule info first
                        await fetch(`http://localhost:8000/rules/${this.editingMapping.id}/mapping`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(savePayload)
                        });

                        // Then reinterpret
                        const response = await fetch(`http://localhost:8000/rules/${this.editingMapping.id}/reinterpret`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        if (!response.ok) {
                            const error = await response.json();
                            throw new Error(error.detail?.message || '재해석 실패');
                        }

                        const result = await response.json();

                        // Update the editingMapping with new AI interpretation
                        this.editingMapping.ai_rule_type = result.ai_rule_type;
                        this.editingMapping.ai_parameters = result.ai_parameters;
                        this.editingMapping.ai_error_message = result.ai_error_message;
                        this.editingMapping.ai_confidence_score = result.ai_confidence_score;

                        // Re-initialize helper fields for parameter editing
                        this.openMappingEditor(this.editingMapping);

                        this.showToast('재해석이 완료되었습니다.', 'success');

                    } catch (e) {
                        console.error('Reinterpret error:', e);
                        this.showToast(`재해석 실패: ${e.message}`, 'error');
                    } finally {
                        this.reinterpretingRule = false;
                    }
                },

                openCreateRuleModal() {
                    this.newRule = {
                        sheet_name: '',
                        custom_sheet_name: '',
                        column_name: '',
                        rule_text: '',
                        condition: '',
                        ai_rule_type: 'required'
                    };
                    // Try to pre-fill sheet name if available
                    if (this.ruleFileDetails && this.ruleFileDetails.sheets && this.ruleFileDetails.sheets.length > 0) {
                        this.newRule.sheet_name = this.ruleFileDetails.sheets[0].sheet_name;
                    }
                    this.createRuleModalOpen = true;
                },

                // =================================================================
                // Rule Editor Logic
                // =================================================================

                async startEditingRule(ruleId) {
                    try {
                        const response = await fetch(`http://localhost:8000/rules/${ruleId}`);
                        if (!response.ok) throw new Error('규칙 정보를 불러올 수 없습니다.');
                        
                        this.editingRule = await response.json();
                        this.editingRuleParamsJson = JSON.stringify(this.editingRule.ai_parameters || {}, null, 2);
                        this.paramsValid = true;
                    } catch (e) {
                        alert('오류: ' + e.message);
                    }
                },

                cancelEditingRule() {
                    this.editingRule = null;
                },

                validateParamsJson() {
                    try {
                        JSON.parse(this.editingRuleParamsJson);
                        this.paramsValid = true;
                    } catch (e) {
                        this.paramsValid = false;
                    }
                },

                async saveRule() {
                    if (!this.paramsValid) return;
                    
                    try {
                        const ruleId = this.editingRule.id;
                        const updates = {
                            field_name: this.editingRule.field_name,
                            rule_text: this.editingRule.rule_text,
                            condition: this.editingRule.condition,
                            note: this.editingRule.note,
                            is_active: this.editingRule.is_active,
                            ai_rule_type: this.editingRule.ai_rule_type,
                            ai_parameters: JSON.parse(this.editingRuleParamsJson)
                        };

                        const response = await fetch(`http://localhost:8000/rules/${ruleId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updates)
                        });

                        if (!response.ok) throw new Error('저장 실패');
                        
                        this.showToast('규칙이 성공적으로 수정되었습니다.', 'success');
                        this.editingRule = null;
                        
                        // Refresh details if open
                        if (this.selectedRuleFile) {
                            this.viewRuleFileDetails(this.selectedRuleFile);
                        }
                    } catch (e) {
                        alert('오류: ' + e.message);
                    }
                },

                // =================================================================
                // Smart Fix Functions
                // =================================================================

                async openSmartFixTab() {
                    if (!this.results || !this.results.errors || this.results.errors.length === 0) {
                        alert('수정할 오류가 없습니다.');
                        return;
                    }

                    // Switch to tab
                    this.currentTab = 'ai_fix';
                    
                    this.isFixLoading = true;
                    this.fixSuggestions = [];
                    this.selectedFixes = [];

                    try {
                        // Get session_id from results metadata if available
                        const sessionId = this.results.metadata?.session_id;

                        if (!sessionId) {
                            // Legacy validation without session - show placeholder message
                            this.isFixLoading = false;
                            alert('AI 수정 제안은 DB 규칙으로 검증한 결과에서만 사용할 수 있습니다.\n\n상단의 "규칙 관리" 탭에서 규칙을 DB에 업로드한 후, "파일 업로드" 탭에서 "저장된 규칙 사용"을 선택하여 검증해주세요.');
                            this.currentTab = 'dashboard'; // Return to dashboard
                            return;
                        }

                        // Get error IDs from DB errors (which have actual IDs)
                        let errorIds = [];
                        if (this.dbErrors && this.dbErrors.length > 0) {
                            errorIds = this.dbErrors.map(e => e.id);
                        }

                        if (errorIds.length === 0) {
                            this.isFixLoading = false;
                            alert('수정 가능한 오류가 없습니다. (DB 에러 ID를 찾을 수 없음)');
                            return;
                        }

                        console.log(`[AI Fix] Found ${errorIds.length} errors with IDs from DB`);

                        // Call AI fix suggestion API
                        const response = await fetch('http://localhost:8000/fix/suggest', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: sessionId,
                                error_ids: errorIds.slice(0, 50) // Limit to 50 for performance
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.detail?.message || '수정 제안 생성 실패');
                        }

                        this.fixSuggestions = await response.json();
                        this.isFixLoading = false;

                        if (this.fixSuggestions.length === 0) {
                            // Stay on tab but show empty state
                            // alert('AI가 수정 제안을 생성할 수 없었습니다...'); // Alert removed as UI handles empty state
                        }
                    } catch (e) {
                        console.error('Fix suggestion error:', e);
                        this.isFixLoading = false;
                        alert('오류: ' + e.message);
                    }
                },

                toggleAllFixes(event) {
                    if (event.target.checked) {
                        this.selectedFixes = this.fixSuggestions.map((_, index) => index);
                    } else {
                        this.selectedFixes = [];
                    }
                },

                filterConfidence(minConfidence) {
                    this.selectedFixes = this.fixSuggestions
                        .map((fix, index) => ({ fix, index }))
                        .filter(({ fix }) => fix.confidence >= minConfidence)
                        .map(({ index }) => index);
                },

                getConfidenceColor(score) {
                    if (score >= 0.9) return 'bg-green-100 text-green-800';
                    if (score >= 0.7) return 'bg-yellow-100 text-yellow-800';
                    return 'bg-red-100 text-red-800';
                },

                async applySelectedFixes() {
                    if (this.selectedFixes.length === 0) {
                        alert('적용할 수정 사항을 선택해주세요.');
                        return;
                    }

                    if (!confirm(`${this.selectedFixes.length}건의 수정 사항을 적용하시겠습니까?`)) {
                        return;
                    }

                    try {
                        // Get selected fix suggestions
                        const fixes = this.selectedFixes.map(index => this.fixSuggestions[index]);

                        // Prepare form data
                        const formData = new FormData();
                        formData.append('fix_request_json', JSON.stringify({ fixes }));

                        // Get original file (need to ask user to upload again)
                        const fileInput = document.getElementById('fileInputA');
                        if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                            alert('원본 파일을 찾을 수 없습니다. 파일을 다시 업로드해주세요.');
                            return;
                        }
                        formData.append('original_file', fileInput.files[0]);

                        // Apply fixes
                        const response = await fetch('http://localhost:8000/fix/apply', {
                            method: 'POST',
                            body: formData
                        });

                        if (!response.ok) {
                            throw new Error('수정 적용 실패');
                        }

                        // Download fixed file
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Fixed_${new Date().toISOString().slice(0,10)}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);

                        this.showToast('수정된 파일이 다운로드되었습니다.', 'success');
                        // this.fixModalOpen = false; // Stay on tab
                    } catch (e) {
                        console.error('Apply fixes error:', e);
                        alert('오류: ' + e.message);
                    }
                }
            }
        }
    </script>
    <!-- Toast Notifications -->
    <div class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="toast.show" 
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-2"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0"
                 x-transition:leave-end="opacity-0 translate-y-2"
                 class="pointer-events-auto min-w-[300px] max-w-md p-4 rounded-lg shadow-lg border flex items-start gap-3 transform"
                 :class="{
                     'bg-white border-green-200': toast.type === 'success',
                     'bg-white border-red-200': toast.type === 'error',
                     'bg-white border-blue-200': toast.type === 'info'
                 }">
                
                <!-- Icons -->
                <i class="ph-fill text-xl mt-0.5" 
                   :class="{
                       'ph-check-circle text-green-500': toast.type === 'success',
                       'ph-warning-circle text-red-500': toast.type === 'error',
                       'ph-info text-blue-500': toast.type === 'info'
                   }"></i>
                
                <div class="flex-1">
                    <h4 class="text-sm font-semibold" 
                        :class="{
                            'text-green-800': toast.type === 'success',
                            'text-red-800': toast.type === 'error',
                            'text-blue-800': toast.type === 'info'
                        }" x-text="toast.title"></h4>
                    <p class="text-sm text-slate-600 mt-1" x-text="toast.message"></p>
                </div>

                <button @click="toast.show = false" class="text-slate-400 hover:text-slate-600">
                    <i class="ph ph-x"></i>
                </button>
            </div>
        </template>
    </div>

    <script>
</body>
</html>